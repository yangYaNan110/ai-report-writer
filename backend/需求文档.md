# AI æŠ¥å‘Šå†™ä½œç³»ç»Ÿ - è¯¦ç»†éœ€æ±‚æ–‡æ¡£

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
æ„å»ºä¸€ä¸ª AI é©±åŠ¨çš„äº¤äº’å¼æŠ¥å‘Šå†™ä½œç³»ç»Ÿï¼Œæ”¯æŒ AI è‡ªä¸»è§„åˆ’å¤§çº²ã€é€æ®µå†™ä½œï¼Œç”¨æˆ·å¯éšæ—¶ä»‹å…¥ç¡®è®¤/ä¿®æ”¹/é‡å†™ä»»æ„æ®µè½ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡
* æ™ºèƒ½å†™ä½œï¼šAIèƒ½æ ¹æ®ä¸»é¢˜è‡ªåŠ¨è§„åˆ’å¤§çº²ã€æ’°å†™å†…å®¹
* äººæœºåä½œï¼šç”¨æˆ·å¯éšæ—¶ä»‹å…¥ï¼Œç¡®è®¤/ä¿®æ”¹/é‡å†™ä»»æ„æ®µè½
* å®æ—¶åé¦ˆï¼šæ‰€æœ‰è€—æ—¶æ“ä½œéƒ½æœ‰è¿›åº¦æç¤ºï¼Œå†…å®¹æµå¼è¾“å‡º
* çµæ´»ä¿®æ”¹ï¼šæ”¯æŒéšæ—¶ä¿®æ”¹å·²å®Œæˆçš„ä»»ä½•æ®µè½
* æ–­ç‚¹ç»­å†™ï¼šç½‘ç»œæ–­å¼€åé‡è¿ï¼Œæ¢å¤ä»»åŠ¡çŠ¶æ€

### 1.3 æŠ€æœ¯é€‰å‹
| ç»„ä»¶ | æŠ€æœ¯æ ˆ | è§’è‰² |
| :--- | :--- | :--- |
| Agentæ¡†æ¶ | Agno | æµç¨‹ç¼–æ’ã€å·¥å…·è°ƒç”¨å†³ç­– |
| MCPæ¡†æ¶ | FastMCP | è€—æ—¶å·¥å…·ç‹¬ç«‹æœåŠ¡ï¼ˆæœç´¢/è§£æ/åˆ†æï¼‰ |
| Skillæœºåˆ¶ | Agno Skills | AIè¡Œä¸ºè§„èŒƒã€å·¥å…·ä½¿ç”¨ç­–ç•¥ |
| Webæ¡†æ¶ | FastAPI | HTTP/WebSocketæ¥å£ |
| æ•°æ®åº“ | SQLite/PostgreSQL | ä¸šåŠ¡çŠ¶æ€å­˜å‚¨ |
| ä»»åŠ¡é˜Ÿåˆ— | Redis | MCPä»»åŠ¡æŒä¹…åŒ–ã€å¤šWorkeråè°ƒ |
| å‰ç«¯ | React + Ant Design X | ç”¨æˆ·ç•Œé¢ |

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```plain
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å‰ç«¯å±‚ (React)                             â”‚
â”‚                 Ant Design X + Zustand + WebSocket                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚ HTTP/WebSocket
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API å±‚ (FastAPI)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Controllers                   èŒè´£                             â”‚  â”‚
â”‚  â”‚ - conversation_controller.py  å¯¹è¯CRUDã€çŠ¶æ€ç®¡ç†               â”‚  â”‚
â”‚  â”‚ - websocket_controller.py     å®æ—¶é€šä¿¡ã€è¿›åº¦æ¨é€               â”‚  â”‚
â”‚  â”‚ - upload_controller.py        æ–‡ä»¶ä¸Šä¼ ã€è§£æè§¦å‘               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Services                      èŒè´£                             â”‚  â”‚
â”‚  â”‚ - conversation_service.py     ä¸šåŠ¡ç¼–æ’ï¼ˆå¼€å§‹/ç¡®è®¤/ä¿®æ”¹/é‡å†™ï¼‰  â”‚  â”‚
â”‚  â”‚ - task_service.py             MCPä»»åŠ¡ç®¡ç†ã€è¿›åº¦è½¬å‘            â”‚  â”‚
â”‚  â”‚ - export_service.py           æ–‡æ¡£å¯¼å‡ºï¼ˆMarkdown/PDFï¼‰         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     models/       â”‚   â”‚      graph/       â”‚   â”‚      store/       â”‚
â”‚   (æ•°æ®æ¨¡å‹å±‚)     â”‚   â”‚   (Agnoç¼–æ’å±‚)    â”‚   â”‚   (å­˜å‚¨å±‚)        â”‚
â”‚ - state.py        â”‚   â”‚ - graph.py        â”‚   â”‚ - storage.py      â”‚
â”‚ - events.py       â”‚   â”‚ - nodes/          â”‚   â”‚ - session.py      â”‚
â”‚ - task.py         â”‚   â”‚ - agents/         â”‚   â”‚ - task_store.py   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MCPå®¢æˆ·ç«¯å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ mcp/client/                   èŒè´£                             â”‚  â”‚
â”‚  â”‚ - client.py      MCPæœåŠ¡å™¨è¿æ¥ç®¡ç†ã€å·¥å…·å‘ç°                   â”‚  â”‚
â”‚  â”‚ - tools.py       å·¥å…·è°ƒç”¨å°è£…ã€ä»»åŠ¡è·Ÿè¸ª                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ MCPåè®®
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MCPæœåŠ¡é›†ç¾¤ (ç‹¬ç«‹éƒ¨ç½²)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœç´¢æœåŠ¡     â”‚  â”‚ è§£ææœåŠ¡     â”‚  â”‚ åˆ†ææœåŠ¡     â”‚  â”‚ æŠ“å–æœåŠ¡ â”‚ â”‚
â”‚  â”‚ search-serverâ”‚  â”‚ parse-server â”‚  â”‚ analyze-serverâ”‚  â”‚fetch-srvâ”‚ â”‚
â”‚  â”‚ FastMCP+Redisâ”‚  â”‚ FastMCP+Redisâ”‚  â”‚ FastMCP+Redisâ”‚  â”‚ FastMCP  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒåˆ†å±‚èŒè´£

| å±‚çº§ | ç›®å½• | æ ¸å¿ƒèŒè´£ | å…³é”®ä¾èµ– |
| :--- | :--- | :--- | :--- |
| æ¥å£å±‚ | `api/controllers/` | HTTP/WebSocketå…¥å£ï¼Œå‚æ•°æ ¡éªŒ | `services` |
| æœåŠ¡å±‚ | `api/services/` | ä¸šåŠ¡ç¼–æ’ã€äº‹åŠ¡ç®¡ç† | `graph`, `store`, `mcp/client` |
| ç¼–æ’å±‚ | `graph/` | Agno Agentæµç¨‹å†³ç­–ã€å·¥å…·è°ƒç”¨ | `models`, `mcp/client` |
| æ•°æ®å±‚ | `models/` | æ ¸å¿ƒæ•°æ®æ¨¡å‹å®šä¹‰ | æ—  |
| å­˜å‚¨å±‚ | `store/` | ä¸šåŠ¡çŠ¶æ€æŒä¹…åŒ–ã€ä¼šè¯ç®¡ç† | `models` |
| MCPå®¢æˆ·ç«¯ | `mcp/client/` | MCPæœåŠ¡è¿æ¥ã€å·¥å…·è°ƒç”¨ | `config` |
| MCPæœåŠ¡ç«¯ | `mcp/servers/` | è€—æ—¶å·¥å…·ç‹¬ç«‹æœåŠ¡ | æ—  |

### 2.3 Skillæœºåˆ¶å®šä½
```plain
skills/                          # æŒ‰éœ€åŠ è½½çš„AIè¡Œä¸ºè§„èŒƒ
â”œâ”€â”€ report-writing/              # å‘Šè¯‰AI"æ€ä¹ˆå†™æŠ¥å‘Š"
â”‚   â”œâ”€â”€ SKILL.md                 # å†™ä½œæ–¹æ³•è®ºã€æ®µè½è§„èŒƒ
â”‚   â””â”€â”€ references/              # æ¨¡æ¿ã€ç¤ºä¾‹ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ tool-usage-strategy/         # å‘Šè¯‰AI"æ€ä¹ˆç”¨å·¥å…·"
â”‚   â””â”€â”€ SKILL.md                 # å·¥å…·è°ƒç”¨ä¼˜å…ˆçº§ã€ç»„åˆç­–ç•¥
â””â”€â”€ data-presentation/           # å‘Šè¯‰AI"æ€ä¹ˆå±•ç¤ºæ•°æ®"
    â””â”€â”€ SKILL.md                 # è¡¨æ ¼æ ¼å¼ã€å›¾è¡¨è§„èŒƒ
```
Skillçš„æ ¸å¿ƒä½œç”¨ï¼ˆä¸æ˜¯ä»£ç ï¼Œæ˜¯AIçš„"å²—ä½SOP"ï¼‰ï¼š
* report-writingï¼šå®šä¹‰æŠ¥å‘Šå†™ä½œæµç¨‹ã€æ®µè½ç»“æ„ã€æ•°æ®å¼•ç”¨è§„èŒƒ
* tool-usage-strategyï¼šå®šä¹‰ä»€ä¹ˆæ—¶å€™è°ƒç”¨å“ªä¸ªMCPå·¥å…·ï¼ˆå¦‚ï¼šæ–‡ä»¶ä¼˜å…ˆã€æœç´¢æ—¶æœºï¼‰
* data-presentationï¼šå®šä¹‰æ•°æ®å¦‚ä½•å‘ˆç°ï¼ˆè¡¨æ ¼æ ¼å¼ã€å¯¹é½è§„åˆ™ï¼‰


## ä¸‰ã€æ¨¡å—è¯¦ç»†è®¾è®¡

### 3.1 models/ - æ•°æ®æ¨¡å‹å±‚ï¼ˆæ ¸å¿ƒå®šä¹‰ï¼‰
#### 3.1.1 state.py - å¯¹è¯çŠ¶æ€

```python
from enum import Enum
from pydantic import BaseModel
from typing import List, Optional

class Phase(str, Enum):
    PLANNING = "planning"          # è§„åˆ’å¤§çº²
    REVIEWING_PLAN = "reviewing_plan"  # ç¡®è®¤å¤§çº²
    WRITING = "writing"            # å†™ä½œä¸­
    REVIEWING_SECTION = "reviewing_section"  # ç¡®è®¤æ®µè½
    COMPLETED = "completed"        # å®Œæˆ

class SectionStatus(str, Enum):
    DRAFT = "draft"        # è‰ç¨¿ï¼ˆç”Ÿæˆä¸­ï¼‰
    CONFIRMED = "confirmed"  # å·²ç¡®è®¤ âœ…
    EDITING = "editing"    # ä¿®æ”¹ä¸­

class Section(BaseModel):
    """æŠ¥å‘Šæ®µè½æ¨¡å‹"""
    id: str                 # æ ¼å¼: "sec-1", "sec-2"
    title: str              # æ®µè½æ ‡é¢˜
    content: str            # æ®µè½å†…å®¹
    status: SectionStatus   # çŠ¶æ€
    version: int = 1        # ç‰ˆæœ¬å·ï¼ˆç”¨äºè¿½è¸ªä¿®æ”¹å†å²ï¼‰

class Message(BaseModel):
    """å¯¹è¯æ¶ˆæ¯ï¼ˆå®Œæ•´å†å²ï¼Œç”¨äºå‰ç«¯å±•ç¤ºï¼‰"""
    role: str               # "user" / "assistant"
    content: str            # æ¶ˆæ¯å†…å®¹
    type: str               # "text" / "confirmation" / "edit_request"
    section_id: Optional[str]  # å…³è”çš„æ®µè½ID
    timestamp: str

class ConversationState(BaseModel):
    """å®Œæ•´çš„å¯¹è¯çŠ¶æ€ï¼ˆä¸šåŠ¡æ ¸å¿ƒï¼‰"""
    # åŸºç¡€ä¿¡æ¯
    thread_id: str
    title: str
    phase: Phase
    version: str = "1.0"
    
    # å†…å®¹
    sections: List[Section] = []
    current_section_id: Optional[str]
    
    # å¯¹è¯å†å²ï¼ˆå®Œæ•´è®°å½•ï¼Œç”¨äºå‰ç«¯å±•ç¤ºï¼‰
    messages: List[Message] = []
    pending_question: Optional[str]      # å½“å‰ç­‰å¾…ç”¨æˆ·å›ç­”çš„é—®é¢˜
    pending_options: List[str] = []      # é€‰é¡¹æŒ‰é’®
    
    # ç¼–è¾‘çŠ¶æ€
    edit_target_id: Optional[str]        # æ­£åœ¨ä¿®æ”¹çš„æ®µè½ID
    edit_instruction: Optional[str]      # ä¿®æ”¹æ„è§
    paused_section_id: Optional[str]     # è¢«æš‚åœçš„æ®µè½ID
    
    # å…ƒæ•°æ®
    created_at: str
    updated_at: str
```

#### 3.1.2 task.py - MCPä»»åŠ¡çŠ¶æ€
```python
class TaskStatus(str, Enum):
    PENDING = "pending"      # ç­‰å¾…æ‰§è¡Œ
    RUNNING = "running"      # æ‰§è¡Œä¸­
    COMPLETED = "completed"  # å®Œæˆ
    FAILED = "failed"        # å¤±è´¥

class TaskInfo(BaseModel):
    """MCPä»»åŠ¡çŠ¶æ€ï¼ˆç”¨äºè¿›åº¦è·Ÿè¸ªï¼‰"""
    task_id: str
    thread_id: str           # å…³è”çš„å¯¹è¯
    tool_name: str           # å·¥å…·åï¼ˆå¦‚ "web_search"ï¼‰
    status: TaskStatus
    progress: float = 0.0    # 0-1 è¿›åº¦
    message: str = ""        # å½“å‰çŠ¶æ€æ¶ˆæ¯ï¼ˆå¦‚"æ­£åœ¨æœç´¢ç¬¬2é¡µ"ï¼‰
    result: Optional[any] = None
    error: Optional[str] = None
    created_at: str
    updated_at: str
```

#### 3.1.3 events.py - WebSocketäº‹ä»¶

```python
class EventType(str, Enum):
    SYNC = "sync"                    # æ–­çº¿é‡è¿åŒæ­¥
    STATE_CHANGE = "state_change"    # çŠ¶æ€å˜æ›´
    STREAM_CHUNK = "stream_chunk"    # æµå¼å†…å®¹ç‰‡æ®µ
    TASK_PROGRESS = "task_progress"  # ä»»åŠ¡è¿›åº¦
    TASK_COMPLETED = "task_completed"  # ä»»åŠ¡å®Œæˆ
    INTERRUPT = "interrupt"          # éœ€è¦ç”¨æˆ·è¾“å…¥
    COMPLETED = "completed"          # å…¨éƒ¨å®Œæˆ
    ERROR = "error"                  # é”™è¯¯

class GraphEvent(BaseModel):
    type: EventType
    data: dict
    timestamp: str
```

### 3.2 store/ - å­˜å‚¨å±‚ï¼ˆä¸šåŠ¡çŠ¶æ€æŒä¹…åŒ–ï¼‰
#### 3.2.1 storage.py - å¯¹è¯å­˜å‚¨
```python
class ConversationStore:
    """ä¸šåŠ¡çŠ¶æ€å­˜å‚¨ï¼ˆæ¢å¤å†™ä½œè¿›åº¦ï¼‰"""
    
    def __init__(self, db_path: str = "data/conversations.db"):
        # åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
        
    def create(self, thread_id: str, title: str) -> ConversationState:
        """åˆ›å»ºæ–°å¯¹è¯"""
        # ç”Ÿæˆåˆå§‹çŠ¶æ€
        # ä¿å­˜åˆ°æ•°æ®åº“
        # è¿”å›çŠ¶æ€å¯¹è±¡
        
    def load(self, thread_id: str) -> Optional[ConversationState]:
        """åŠ è½½å¯¹è¯ï¼ˆç”¨äºæ–­çº¿é‡è¿ï¼‰"""
        # ä»æ•°æ®åº“è¯»å–JSON
        # ååºåˆ—åŒ–ä¸ºConversationState
        # è¿”å›çŠ¶æ€å¯¹è±¡
        
    def save(self, state: ConversationState):
        """ä¿å­˜çŠ¶æ€ï¼ˆæ¯æ¬¡å˜æ›´åè°ƒç”¨ï¼‰"""
        # åºåˆ—åŒ–ä¸ºJSON
        # UPSERTåˆ°æ•°æ®åº“
        # æ›´æ–°updated_at
        
    def list(self, user_id: str) -> List[dict]:
        """è·å–å¯¹è¯åˆ—è¡¨ï¼ˆæ ‡é¢˜ã€é˜¶æ®µã€æ›´æ–°æ—¶é—´ï¼‰"""
        # åªè¿”å›å…ƒæ•°æ®ï¼Œä¸è¿”å›å®Œæ•´çŠ¶æ€
```

#### 3.2.2 session.py - WebSocketä¼šè¯ç®¡ç†
```python 
class SessionManager:
    """WebSocketè¿æ¥ç®¡ç†ï¼ˆæ”¯æŒæ–­çº¿é‡è¿ï¼‰"""
    
    def __init__(self):
        self.active_connections: Dict[str, WebSocket] = {}  # session_id -> ws
        self.thread_sessions: Dict[str, str] = {}           # thread_id -> session_id
        self.pending_messages: Dict[str, list] = {}         # ç¦»çº¿æ¶ˆæ¯ç¼“å­˜
    
    async def connect(self, thread_id: str, websocket: WebSocket):
        """å»ºç«‹è¿æ¥ï¼ˆå¦‚æœå·²æœ‰è¿æ¥ï¼Œè¸¢æ‰æ—§çš„ï¼‰"""
        # 1. æ¥å—WebSocketè¿æ¥
        # 2. æ£€æŸ¥thread_idæ˜¯å¦å·²æœ‰æ´»è·ƒè¿æ¥ï¼Œæœ‰åˆ™å…³é—­
        # 3. ä¿å­˜æ–°è¿æ¥
        # 4. å‘é€ç¦»çº¿æ¶ˆæ¯ï¼ˆå¦‚æœ‰ï¼‰
    
    def disconnect(self, thread_id: str):
        """æ–­å¼€è¿æ¥"""
        # æ¸…ç†è¿æ¥è®°å½•
    
    async def send_message(self, thread_id: str, message: dict):
        """å‘é€æ¶ˆæ¯ï¼ˆå¦‚æœç¦»çº¿åˆ™ç¼“å­˜ï¼‰"""
        # 1. æŸ¥æ‰¾è¯¥thread_idçš„æ´»è·ƒè¿æ¥
        # 2. å¦‚æœæœ‰ï¼Œç«‹å³å‘é€
        # 3. å¦‚æœæ²¡æœ‰ï¼Œç¼“å­˜æ¶ˆæ¯ï¼ˆæœ€å¤š10æ¡ï¼‰
```
#### 3.2.3 task_store.py - MCPä»»åŠ¡å­˜å‚¨ï¼ˆRedisï¼‰
```python
class TaskStore:
    """MCPä»»åŠ¡çŠ¶æ€å­˜å‚¨ï¼ˆæ”¯æŒæ–­çº¿é‡è¿æ¢å¤è¿›åº¦ï¼‰"""
    
    def __init__(self, redis_url: str = "redis://localhost:6379"):
        self.redis = redis.from_url(redis_url)
        self.prefix = "task:"
    
    def save(self, task: TaskInfo):
        """ä¿å­˜ä»»åŠ¡çŠ¶æ€"""
        # key: task:{task_id}
        # è®¾ç½®1å°æ—¶è¿‡æœŸï¼ˆä»»åŠ¡å®Œæˆåå¯å»¶é•¿ï¼‰
    
    def get(self, task_id: str) -> Optional[TaskInfo]:
        """è·å–ä»»åŠ¡çŠ¶æ€"""
        
    def get_thread_tasks(self, thread_id: str) -> List[TaskInfo]:
        """è·å–å¯¹è¯çš„æ‰€æœ‰è¿›è¡Œä¸­ä»»åŠ¡"""
        # ç”¨äºæ–­çº¿é‡è¿æ—¶æ¢å¤è¿›åº¦
        
    def update_progress(self, task_id: str, progress: float, message: str):
        """æ›´æ–°ä»»åŠ¡è¿›åº¦"""
        # TaskServiceè½®è¯¢MCPä»»åŠ¡æ—¶è°ƒç”¨
```

### 3.3 graph/ - Agnoç¼–æ’å±‚ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
#### 3.3.1 ç›®å½•ç»“æ„
```text
graph/
â”œâ”€â”€ graph.py                 # ConversationGraph ä¸»ç±»ï¼ˆçŠ¶æ€è·¯ç”±ï¼‰
â”œâ”€â”€ edges.py                 # çŠ¶æ€è½¬æ¢é€»è¾‘
â”œâ”€â”€ nodes/                   # å„é˜¶æ®µèŠ‚ç‚¹
â”‚   â”œâ”€â”€ plan.py              # è§„åˆ’å¤§çº²
â”‚   â”œâ”€â”€ plan_review.py       # å¤§çº²ç¡®è®¤
â”‚   â”œâ”€â”€ write_section.py     # å†™æ®µè½ï¼ˆæµå¼ï¼‰
â”‚   â”œâ”€â”€ section_review.py    # æ®µè½ç¡®è®¤
â”‚   â”œâ”€â”€ edit_section.py      # ä¿®æ”¹æ®µè½
â”‚   â””â”€â”€ complete.py          # å®Œæˆ
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ report_agent.py      # Agno ReportAgentï¼ˆå¸¦Skillsï¼‰
â”‚   â””â”€â”€ mcp_client.py        # MCPå®¢æˆ·ç«¯å°è£…
â””â”€â”€ prompts/                 # æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰
```

#### 3.3.2 agents/report_agent.py - Agno Agent
```python
from agno.agent import Agent
from agno.models.dashscope import DashScope
from agno.skills import Skills
from agno.db.sqlite import SqliteDb

class ReportAgent:
    """
    Agno Agent æ ¸å¿ƒ
    èŒè´£ï¼šæµç¨‹å†³ç­– + å·¥å…·è°ƒç”¨ + æŠ€èƒ½åŠ è½½
    """
    
    def __init__(self, mcp_client, skill_paths: List[str]):
        # 1. åŠ è½½Skillsï¼ˆæŒ‰éœ€åŠ è½½çš„è¡Œä¸ºè§„èŒƒï¼‰
        self.skills = Skills(loaders=[LocalSkills(p) for p in skill_paths])
        
        # 2. åˆ›å»ºAgno Agent
        self.agent = Agent(
            # åŸºç¡€ä¿¡æ¯
            name="ä¸“ä¸šçš„æŠ¥å‘Šå†™ä½œåŠ©æ‰‹",
            description="æ“…é•¿æŠ€æœ¯æŠ¥å‘Šã€å¸‚åœºåˆ†æã€å­¦æœ¯ç»¼è¿°",
            
            # æ¨¡å‹é…ç½®
            model=DashScope(
                id="qwen-max-latest",
                api_key=api_key,
                base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
            ),
            
            # å¸¸é©»æŒ‡ä»¤ï¼ˆé€šç”¨è¡Œä¸ºå‡†åˆ™ï¼‰
            instructions=[
                "ä¸ç¡®å®šæ—¶å¦‚å®å‘ŠçŸ¥ï¼Œä¸ç¼–é€ æ•°æ®",
                "è¯­è¨€é£æ ¼ï¼šä¸“ä¸šã€å®¢è§‚ã€ç®€æ´",
                "æ ¼å¼è¦æ±‚ï¼šMarkdownå±‚çº§æ¸…æ™°",
                "å†™ä½œå‰è§„åˆ’å¤§çº²ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤",
                "æ¯æ®µå®Œæˆåè¯¢é—®ç”¨æˆ·æ˜¯å¦æ»¡æ„",
                "å¤šæ­¥ä»»åŠ¡æ—¶ä¸»åŠ¨å‘ŠçŸ¥ç”¨æˆ·è¿›åº¦",
            ],
            
            # æŒ‰éœ€åŠ è½½çš„ä¸“ä¸šçŸ¥è¯†ï¼ˆæ¥è‡ªSkillsï¼‰
            skills=self.skills,
            
            # MCPå·¥å…·ï¼ˆé€šè¿‡MCPClientå‘ç°ï¼‰
            tools=[mcp_client],
            show_tool_calls=True,      # æ˜¾ç¤ºå·¥å…·è°ƒç”¨è¿‡ç¨‹
            
            # è¾“å‡ºæ ¼å¼
            markdown=True,
            
            # è®°å¿†ç®¡ç†ï¼ˆç”¨äºå¤šè½®å¯¹è¯ï¼‰
            db=SqliteDb(db_file="data/agent_sessions.db"),
            add_history_to_context=True,
            num_history_messages=5,     # åªå–æœ€è¿‘5æ¡ä½œä¸ºä¸Šä¸‹æ–‡
            enable_session_summaries=True,  # é•¿å¯¹è¯æ‘˜è¦
            
            # å·¥å…·ç»“æœå‹ç¼©ï¼ˆèŠ‚çœTokenï¼‰
            compress_tool_results=True,
        )
    
    async def run(self, task: str, context: dict = None, stream: bool = False):
        """æ‰§è¡Œä»»åŠ¡ï¼ˆæ”¯æŒæµå¼ï¼‰"""
        if stream:
            async for chunk in self.agent.arun(task, context=context, stream=True):
                yield chunk
        else:
            return await self.agent.arun(task, context=context)
```

#### 3.3.3 agents/mcp_client.py - MCPå®¢æˆ·ç«¯å°è£…
```python
from agno.tools.mcp import MCPTools, MultiMCPTools

class MCPClient:
    """
    MCPå®¢æˆ·ç«¯ç®¡ç†
    èŒè´£ï¼šè¿æ¥MCPæœåŠ¡ã€å·¥å…·å‘ç°ã€è°ƒç”¨å°è£…
    """
    
    def __init__(self, server_configs: List[dict]):
        """
        server_configs: [
            {"name": "search", "url": "http://localhost:8001/mcp"},
            {"name": "parse", "url": "http://localhost:8002/mcp"},
        ]
        """
        self.client = MultiMCPTools(
            urls=[cfg["url"] for cfg in server_configs],
            urls_transports=["streamable-http"] * len(server_configs),
            timeout_seconds=120
        )
    
    async def connect(self):
        """è¿æ¥æ‰€æœ‰MCPæœåŠ¡å™¨"""
        await self.client.connect()
    
    async def close(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        await self.client.close()
    
    async def call_tool(self, tool_name: str, params: dict) -> dict:
        """è°ƒç”¨å·¥å…·ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„MCPæœåŠ¡å™¨ï¼‰"""
        return await self.client.call_tool(tool_name, params)
    
    def get_tools(self):
        """è·å–å·¥å…·åˆ—è¡¨ï¼ˆç”¨äºAgentåˆå§‹åŒ–ï¼‰"""
        return [self.client]  # Agnoçš„MCPToolsæ ¼å¼
```

#### 3.3.4 nodes/write_section.py - å†™ä½œèŠ‚ç‚¹ç¤ºä¾‹
```python
async def write_section_node(state: ConversationState) -> AsyncIterator[GraphEvent]:
    """
    å†™ä½œèŠ‚ç‚¹
    èŒè´£ï¼šè°ƒç”¨Agentç”Ÿæˆæ®µè½å†…å®¹ï¼Œæµå¼è¿”å›
    """
    # 1. è·å–å½“å‰è¦å†™çš„æ®µè½
    current_section = state.get_current_section()
    
    # 2. æ„å»ºä¸Šä¸‹æ–‡ï¼ˆåŒ…å«ä¹‹å‰å·²ç¡®è®¤çš„å†…å®¹ï¼‰
    context = {
        "previous_sections": [
            s.content for s in state.sections 
            if s.status == SectionStatus.CONFIRMED
        ],
        "current_title": current_section.title,
        "report_title": state.title
    }
    
    # 3. Agentåˆ¤æ–­æ˜¯å¦éœ€è¦MCPå·¥å…·
    # ï¼ˆæ ¹æ®tool-usage-strategy Skillè‡ªåŠ¨å†³ç­–ï¼‰
    
    # 4. æµå¼ç”Ÿæˆå†…å®¹
    async for chunk in report_agent.run(
        f"å†™{current_section.title}éƒ¨åˆ†",
        context=context,
        stream=True
    ):
        # è¿½åŠ å†…å®¹
        current_section.content += chunk
        
        # æ¨é€æµå¼ç‰‡æ®µ
        yield GraphEvent(
            type=EventType.STREAM_CHUNK,
            data={
                "section_id": current_section.id,
                "content": chunk
            }
        )
        
        # ä¿å­˜çŠ¶æ€ï¼ˆä¾¿äºæ–­ç‚¹ç»­å†™ï¼‰
        store.save(state)
    
    # 5. æ®µè½å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤
    current_section.status = SectionStatus.DRAFT
    yield GraphEvent(
        type=EventType.INTERRUPT,
        data={
            "question": f"{current_section.title}å®Œæˆï¼Œæ‚¨æ»¡æ„å—ï¼Ÿ",
            "options": ["ç¡®è®¤", "ä¿®æ”¹", "é‡å†™"],
            "section_id": current_section.id
        }
    )
```

### 3.4 mcp/servers/ - FastMCPæœåŠ¡é›†ç¾¤ï¼ˆç‹¬ç«‹éƒ¨ç½²ï¼‰
#### 3.4.1 search-server/server.py - æœç´¢æœåŠ¡

```python
"""
æœç´¢æœåŠ¡ - ç‹¬ç«‹éƒ¨ç½²
èŒè´£ï¼šæä¾›å¸¦è¿›åº¦åé¦ˆçš„ç½‘ç»œæœç´¢èƒ½åŠ›
"""
from fastmcp import FastMCP
from fastmcp.dependencies import Progress

mcp = FastMCP("search-server", port=8001, tasks=True)

@mcp.tool(task=True)
async def web_search(query: str, max_pages: int = 3, progress: Progress = Progress()) -> str:
    """
    æœç´¢ç½‘ç»œä¿¡æ¯
    
    Args:
        query: æœç´¢å…³é”®è¯ï¼ˆå¦‚ "AI 2024è¶‹åŠ¿"ï¼‰
        max_pages: æœ€å¤§æœç´¢é¡µæ•°
        progress: è¿›åº¦æ³¨å…¥ï¼ˆFastMCPè‡ªåŠ¨æä¾›ï¼‰
    
    Returns:
        æ ¼å¼åŒ–çš„æœç´¢ç»“æœï¼ˆMarkdownæ ¼å¼ï¼‰
    """
    # 1. è®¾ç½®æ€»è¿›åº¦
    await progress.set_total(max_pages + 1)
    await progress.set_message(f"ğŸ” å¼€å§‹æœç´¢ '{query}'...")
    
    # 2. é€é¡µæœç´¢
    for page in range(1, max_pages + 1):
        await progress.set_message(f"ğŸ“„ æ­£åœ¨æœç´¢ç¬¬ {page} é¡µ...")
        
        # å®é™…æœç´¢é€»è¾‘ï¼ˆè°ƒç”¨æœç´¢å¼•æ“APIï¼‰
        results = await search_engine.search(query, page)
        
        await progress.increment()
    
    # 3. æ ¼å¼åŒ–ç»“æœ
    return format_results(query, all_results)

@mcp.tool()
async def get_server_info() -> dict:
    """è·å–æœåŠ¡ä¿¡æ¯ï¼ˆç”¨äºå¥åº·æ£€æŸ¥ï¼‰"""
    return {
        "name": "search-server",
        "version": "1.0.0",
        "features": ["background-tasks", "progress-reporting"]
    }

if __name__ == "__main__":
    mcp.run(transport="streamable-http")
```
#### 3.4.2 æ‰€æœ‰MCPæœåŠ¡é…ç½®
```yaml
# docker-compose.ymlï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
version: '3.8'
services:
  search-server:
    build: ./mcp/servers/search-server
    ports:
      - "8001:8001"
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
  
  parse-server:
    build: ./mcp/servers/parse-server
    ports:
      - "8002:8002"
    environment:
      - REDIS_URL=redis://redis:6379
  
  analyze-server:
    build: ./mcp/servers/analyze-server
    ports:
      - "8003:8003"
    environment:
      - REDIS_URL=redis://redis:6379
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
```

### 3.5 api/ - æ¥å£å±‚
#### 3.5.1 services/conversation_service.py - ä¸šåŠ¡ç¼–æ’
```python
class ConversationService:
    """
    ä¸šåŠ¡ç¼–æ’æ ¸å¿ƒ
    èŒè´£ï¼šç»„åˆStore + Graph + SessionManager
    """
    
    def __init__(self, store, graph, session_manager):
        self.store = store
        self.graph = graph
        self.session = session_manager
    
    async def start(self, thread_id: str, title: str = None):
        """å¼€å§‹æ–°å¯¹è¯"""
        # 1. åŠ è½½æˆ–åˆ›å»ºçŠ¶æ€
        state = self.store.load(thread_id)
        if not state:
            state = self.store.create(thread_id, title)
        
        # 2. æ‰§è¡ŒGraphï¼ˆè§„åˆ’å¤§çº²ï¼‰
        async for event in self.graph.run(state, input={"action": "start"}):
            # 3. ä¿å­˜çŠ¶æ€
            self.store.save(event.state)
            
            # 4. é€šè¿‡WebSocketæ¨é€äº‹ä»¶
            await self.session.send_message(thread_id, event.dict())
    
    async def submit_feedback(self, thread_id: str, feedback: str):
        """æäº¤ç”¨æˆ·åé¦ˆï¼ˆç¡®è®¤/ä¿®æ”¹æ„è§ï¼‰"""
        state = self.store.load(thread_id)
        
        # æ ¹æ®åé¦ˆç±»å‹å¤„ç†
        if feedback == "ç¡®è®¤":
            input_data = {"action": "approve"}
        else:
            # ä¿®æ”¹æ„è§
            input_data = {
                "action": "edit",
                "instruction": feedback
            }
        
        # æ‰§è¡ŒGraph
        async for event in self.graph.run(state, input=input_data):
            self.store.save(event.state)
            await self.session.send_message(thread_id, event.dict())
    
    async def edit_section(self, thread_id: str, section_id: str, instruction: str):
        """ä¿®æ”¹æŒ‡å®šæ®µè½"""
        state = self.store.load(thread_id)
        
        # æš‚åœå½“å‰ä»»åŠ¡
        state.paused_section_id = state.current_section_id
        state.current_section_id = None
        
        # æ ‡è®°è¦ä¿®æ”¹çš„æ®µè½
        state.edit_target_id = section_id
        state.edit_instruction = instruction
        
        self.store.save(state)
        
        # æ‰§è¡Œä¿®æ”¹
        async for event in self.graph.run(state, input={"action": "edit_section"}):
            self.store.save(event.state)
            await self.session.send_message(thread_id, event.dict())
```

#### 3.5.2 services/task_service.py - MCPä»»åŠ¡ç®¡ç†
```python
class TaskService:
    """
    MCPä»»åŠ¡ç®¡ç†
    èŒè´£ï¼šè½®è¯¢ä»»åŠ¡çŠ¶æ€ã€æ¨é€è¿›åº¦
    """
    
    def __init__(self, task_store: TaskStore, session_manager: SessionManager):
        self.task_store = task_store
        self.session = session_manager
        self.running = False
    
    async def start_polling(self):
        """å¯åŠ¨è½®è¯¢ï¼ˆåå°ä»»åŠ¡ï¼‰"""
        self.running = True
        while self.running:
            # æŸ¥è¯¢æ‰€æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡
            tasks = self.task_store.get_running_tasks()
            
            for task in tasks:
                # æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼ˆé€šè¿‡MCPå®¢æˆ·ç«¯ï¼‰
                current = await mcp_client.get_task_status(task.task_id)
                
                if current.progress != task.progress:
                    # è¿›åº¦æœ‰å˜åŒ–ï¼Œæ¨é€
                    await self.session.send_message(
                        task.thread_id,
                        {
                            "type": "task_progress",
                            "task_id": task.task_id,
                            "progress": current.progress,
                            "message": current.message
                        }
                    )
                
                if current.status == "completed":
                    await self.session.send_message(
                        task.thread_id,
                        {
                            "type": "task_completed",
                            "task_id": task.task_id,
                            "result": current.result
                        }
                    )
                
                # æ›´æ–°å­˜å‚¨
                self.task_store.save(current)
            
            await asyncio.sleep(1)  # æ¯ç§’è½®è¯¢ä¸€æ¬¡
```


## å››ã€æ¥å£è®¾è®¡
### 4.1 REST API
#### 4.1.1 å¯¹è¯ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯·æ±‚ | å“åº” | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| POST | `/api/conversations` | `{"title": "æŠ¥å‘Šæ ‡é¢˜"}` | `{"thread_id": "conv_123", "state": {...}}` | åˆ›å»ºæ–°å¯¹è¯ |
| GET | `/api/conversations` | - | `[{"thread_id": "...", "title": "...", "phase": "..."}]` | è·å–å¯¹è¯åˆ—è¡¨ |
| GET | `/api/conversations/{id}` | - | `{"thread_id": "...", "state": {...}}` | è·å–å®Œæ•´çŠ¶æ€ï¼ˆç”¨äºæ¢å¤ï¼‰ |
| DELETE | `/api/conversations/{id}` | - | `{"success": true}` | åˆ é™¤å¯¹è¯ |
| GET | `/api/conversations/{id}/history` | - | `{"messages": [...], "total": 100}` | è·å–å®Œæ•´å¯¹è¯å†å²ï¼ˆå‰ç«¯å±•ç¤ºï¼‰ |

#### 4.1.2 æ–‡æ¡£å¯¼å‡º

| æ–¹æ³• | è·¯å¾„ | è¯·æ±‚ | å“åº” | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| POST | `/api/conversations/{id}/export` | `{"format": "markdown"}` | `{"content": "...", "filename": "æŠ¥å‘Š.md"}` | å¯¼å‡ºæœ€ç»ˆæ–‡æ¡£ï¼ˆä¸å«å¯¹è¯å†å²ï¼‰ |
| GET | `/api/conversations/{id}/export/preview` | - | `{"content": "..."}` | é¢„è§ˆå¯¼å‡ºæ•ˆæœ |

#### 4.1.3 æ–‡ä»¶ä¸Šä¼ 

| æ–¹æ³• | è·¯å¾„ | è¯·æ±‚ | å“åº” | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| POST | `/api/upload` | `multipart/form-data` | `{"task_id": "task_123", "status": "processing"}` | ä¸Šä¼ æ–‡ä»¶ï¼ˆè§¦å‘è§£ææœåŠ¡ï¼‰ |
| GET | `/api/upload/status/{task_id}` | - | `{"progress": 0.5, "message": "è§£æä¸­..."}` | æŸ¥è¯¢è§£æè¿›åº¦ |

### 4.2 WebSocket åè®®
#### 4.2.1 è¿æ¥
```text
ws://localhost:8000/ws/{thread_id}
```
#### 4.2.2 å®¢æˆ·ç«¯ -> æœåŠ¡ç«¯æ¶ˆæ¯
```json
// 1. å¼€å§‹å†™ä½œ
{
  "action": "start",
  "payload": {
    "title": "2024 AIå‘å±•è¶‹åŠ¿æŠ¥å‘Š"
  }
}

// 2. æäº¤åé¦ˆï¼ˆç¡®è®¤/ä¿®æ”¹ï¼‰
{
  "action": "feedback",
  "payload": {
    "feedback": "ç¡®è®¤å¤§çº²"  // æˆ– "å¢åŠ ä¸€äº›æ•°æ®"
  }
}

// 3. ä¿®æ”¹æŒ‡å®šæ®µè½
{
  "action": "edit_section",
  "payload": {
    "section_id": "sec-1",
    "instruction": "å¢åŠ 2024å¹´çš„å…·ä½“æ•°æ®"
  }
}

// 4. ç¡®è®¤æ®µè½
{
  "action": "approve_section",
  "payload": {
    "section_id": "sec-1"
  }
}

// 5. é‡å†™æ®µè½
{
  "action": "regenerate_section",
  "payload": {
    "section_id": "sec-1"
  }
}

// 6. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
{
  "action": "task_status",
  "payload": {
    "task_id": "task_123"
  }
}
```

#### 4.2.3 æœåŠ¡ç«¯ -> å®¢æˆ·ç«¯æ¶ˆæ¯
```json
// 1. æ–­çº¿é‡è¿åŒæ­¥
{
  "type": "sync",
  "data": {
    "phase": "writing",
    "sections": [...],           // æ‰€æœ‰æ®µè½
    "current_section_id": "sec-2",
    "pending_tasks": [           // è¿›è¡Œä¸­çš„MCPä»»åŠ¡
      {"task_id": "task_123", "progress": 0.3, "message": "æœç´¢ç¬¬2é¡µ..."}
    ],
    "pending_question": "ç¬¬1æ®µå®Œæˆï¼Œæ‚¨æ»¡æ„å—ï¼Ÿ",
    "pending_options": ["ç¡®è®¤", "ä¿®æ”¹", "é‡å†™"]
  }
}

// 2. çŠ¶æ€å˜æ›´
{
  "type": "state_change",
  "data": {
    "phase": "writing",
    "sections": [...],
    "current_section_id": "sec-2"
  }
}

// 3. æµå¼å†…å®¹ç‰‡æ®µ
{
  "type": "stream_chunk",
  "data": {
    "section_id": "sec-2",
    "content": "2024å¹´ï¼Œäººå·¥æ™ºèƒ½é¢†åŸŸ..."
  }
}

// 4. MCPä»»åŠ¡è¿›åº¦
{
  "type": "task_progress",
  "data": {
    "task_id": "task_123",
    "progress": 0.5,
    "message": "æ­£åœ¨æœç´¢ç¬¬2é¡µ..."
  }
}

// 5. MCPä»»åŠ¡å®Œæˆ
{
  "type": "task_completed",
  "data": {
    "task_id": "task_123",
    "result": "æœç´¢ç»“æœæ‘˜è¦..."
  }
}

// 6. éœ€è¦ç”¨æˆ·è¾“å…¥
{
  "type": "interrupt",
  "data": {
    "question": "ç¬¬1æ®µå®Œæˆï¼Œæ‚¨æ»¡æ„å—ï¼Ÿ",
    "options": ["ç¡®è®¤", "ä¿®æ”¹", "é‡å†™"],
    "section_id": "sec-1"
  }
}

// 7. å…¨éƒ¨å®Œæˆ
{
  "type": "completed",
  "data": {
    "stats": {
      "total_sections": 5,
      "total_words": 3500
    }
  }
}

// 8. é”™è¯¯
{
  "type": "error",
  "data": {
    "message": "æœç´¢æœåŠ¡æš‚æ—¶ä¸å¯ç”¨",
    "retryable": true
  }
}

```

## äº”ã€Skillè®¾è®¡ï¼ˆæ ¸å¿ƒè¡Œä¸ºè§„èŒƒï¼‰
### 5.1 report-writing Skill - å†™ä½œè§„èŒƒ

```yaml
# skills/report-writing/SKILL.md
name: report-writing
description: ä¸“ä¸šæŠ¥å‘Šå†™ä½œè§„èŒƒä¸æµç¨‹
metadata:
  version: "1.0.0"
  tags: ["å†™ä½œ", "æŠ¥å‘Š", "è§„èŒƒ"]

# æŠ¥å‘Šå†™ä½œæ–¹æ³•è®º

## 1. å¤§çº²è§„åˆ’æµç¨‹
- å…ˆç¡®å®šæŠ¥å‘Šçš„æ ¸å¿ƒè®ºç‚¹ï¼ˆ1-2å¥è¯ï¼‰
- ç„¶åæ‹†è§£ä¸º3-5ä¸ªæ”¯æ’‘ç« èŠ‚
- æ¯ä¸ªç« èŠ‚å¿…é¡»æœ‰æ˜ç¡®çš„ä¸»é¢˜å¥
- å¤§çº²ç”Ÿæˆåå¿…é¡»ç­‰å¾…ç”¨æˆ·ç¡®è®¤

## 2. æ®µè½ç»“æ„è§„èŒƒ
æ¯ä¸ªæ®µè½å¿…é¡»åŒ…å«ï¼š
- **ä¸»é¢˜å¥**ï¼šæ®µè½çš„ç¬¬ä¸€å¥ï¼Œæ¦‚æ‹¬æœ¬æ®µæ ¸å¿ƒ
- **è®ºæ®æ”¯æ’‘**ï¼šè‡³å°‘1ä¸ªæ•°æ®/æ¡ˆä¾‹/å¼•ç”¨
- **è¿‡æ¸¡å¥**ï¼šè¿æ¥åˆ°ä¸‹ä¸€æ®µ

## 3. æ•°æ®å¼•ç”¨è§„åˆ™
- æ‰€æœ‰å¤–éƒ¨æ•°æ®å¿…é¡»æ ‡æ³¨æ¥æº
- æ ¼å¼ï¼š`æ ¹æ®[æ¥æº]ï¼Œ[å¹´ä»½]ï¼Œ[æ•°æ®]`
- ç¤ºä¾‹ï¼š`æ ¹æ®IDCæŠ¥å‘Šï¼Œ2024å¹´AIå¸‚åœºè§„æ¨¡è¾¾5000äº¿ç¾å…ƒ`

## 4. ç”¨æˆ·äº¤äº’æµç¨‹
- å¤§çº²ç”Ÿæˆåï¼šå¿…é¡»è¯¢é—®â€œæ‚¨å¯¹å¤§çº²æ»¡æ„å—ï¼Ÿâ€
- æ¯æ®µå®Œæˆåï¼šå¿…é¡»è¯¢é—®â€œæ®µè½å®Œæˆï¼Œæ‚¨æ»¡æ„å—ï¼Ÿâ€
- ç”¨æˆ·ä¿®æ”¹æ„è§ï¼šç²¾ç¡®å®šä½åˆ°å…·ä½“æ®µè½ä¿®æ”¹

## 5. è¾“å‡ºæ ¼å¼è¦æ±‚
- ä½¿ç”¨Markdownæ ¼å¼
- äºŒçº§æ ‡é¢˜ï¼ˆ##ï¼‰ç”¨äºç« èŠ‚åˆ’åˆ†
- åˆ—è¡¨é¡¹ä½¿ç”¨`-`ç¬¦å·
- ä»£ç å—æ ‡æ³¨è¯­è¨€
```
### 5.2 tool-usage-strategy Skill - å·¥å…·è°ƒç”¨ç­–ç•¥
```yaml
# skills/tool-usage-strategy/SKILL.md
name: tool-usage-strategy
description: MCPå·¥å…·è°ƒç”¨ä¼˜å…ˆçº§ç­–ç•¥
metadata:
  version: "1.0.0"
  tags: ["å·¥å…·", "ç­–ç•¥"]

# å·¥å…·è°ƒç”¨è§„åˆ™

## 1. æœç´¢æœåŠ¡ä½¿ç”¨è§„åˆ™
- å½“éœ€è¦æœ€æ–°æ•°æ®æ—¶ï¼Œä¼˜å…ˆè°ƒç”¨ `search-server` çš„ `web_search`
- æœç´¢å‚æ•°å»ºè®®ï¼šé»˜è®¤3é¡µï¼Œå¯é€‚å½“è°ƒæ•´
- å¦‚æœæœç´¢ç»“æœä¸è¶³ï¼Œå°è¯•åŒä¹‰è¯æ‰©å±•
- ç¤ºä¾‹ï¼šç”¨æˆ·è¯´â€œæŸ¥ä¸€ä¸‹2024å¹´AIèèµ„æ•°æ®â€ â†’ è°ƒç”¨æœç´¢

## 2. è§£ææœåŠ¡ä½¿ç”¨è§„åˆ™
- å½“ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œä¼˜å…ˆè°ƒç”¨ `parse-server` çš„ `parse_document`
- æ”¯æŒæ ¼å¼ï¼šPDFã€DOCXã€TXT
- è§£æå®Œæˆåï¼Œæ ¹æ®å†…å®¹å†³å®šæ˜¯å¦éœ€è¦æœç´¢è¡¥å……
- ç¤ºä¾‹ï¼šç”¨æˆ·ä¸Šä¼ PDF â†’ å…ˆè§£æï¼Œå†åˆ†æ

## 3. åˆ†ææœåŠ¡ä½¿ç”¨è§„åˆ™
- éœ€è¦å¯¹å†…å®¹æ·±åº¦ç†è§£æ—¶è°ƒç”¨ `analyze-server` çš„ `analyze_content`
- åˆ†æç»´åº¦ï¼šæ‘˜è¦ã€å…³é”®è¯ã€æƒ…æ„Ÿã€å®ä½“
- ç¤ºä¾‹ï¼šè§£ææ–‡æ¡£å â†’ è°ƒç”¨åˆ†ææå–å…³é”®ä¿¡æ¯

## 4. å¤šå·¥å…·ååŒ
- **æ–‡ä»¶ä¼˜å…ˆåŸåˆ™**ï¼šå¦‚æœç”¨æˆ·ä¸Šä¼ äº†æ–‡ä»¶ï¼Œä¼˜å…ˆè§£ææ–‡ä»¶
- **æ•°æ®è¡¥å……åŸåˆ™**ï¼šè§£æåå‘ç°æ•°æ®ä¸è¶³ï¼Œå†è°ƒç”¨æœç´¢
- **åˆ†æå…ˆè¡ŒåŸåˆ™**ï¼šéœ€è¦æ·±åº¦åˆ†ææ—¶ï¼Œå…ˆè§£æå†åˆ†æ
```

### 5.3 data-presentation Skill - æ•°æ®å±•ç¤ºè§„èŒƒ
```yaml
# skills/data-presentation/SKILL.md
name: data-presentation
description: æ•°æ®å±•ç¤ºæ ¼å¼è§„èŒƒ
metadata:
  version: "1.0.0"
  tags: ["æ•°æ®", "è¡¨æ ¼", "æ ¼å¼"]

```
### æ•°æ®å‘ˆç°è§„åˆ™

#### 1. è¡¨æ ¼ä½¿ç”¨è§„èŒƒ
å½“æ¶‰åŠå¤šç»„æ•°æ®å¯¹æ¯”æ—¶ï¼Œå¿…é¡»ä½¿ç”¨Markdownè¡¨æ ¼ï¼š

| æŒ‡æ ‡ | 2023å¹´ | 2024å¹´ | åŒæ¯”å¢é•¿ |
|------|--------|--------|----------|
| è¥æ”¶(äº¿å…ƒ) | 100 | 135 | +35% |
| ç”¨æˆ·æ•°(ä¸‡) | 500 | 780 | +56% |



è¡¨æ ¼è§„åˆ™ï¼š
* å¿…é¡»æœ‰è¡¨å¤´ï¼ˆç¬¬ä¸€è¡Œï¼‰
* å¿…é¡»æœ‰å¯¹é½çº¿ï¼ˆç¬¬äºŒè¡Œï¼‰
* æ•°å­—å³å¯¹é½ï¼Œæ–‡æœ¬å·¦å¯¹é½
* å•ä½åœ¨è¡¨å¤´æˆ–å•å…ƒæ ¼ä¸­æ ‡æ˜

#### 2. é€‚ç”¨åœºæ™¯

* å¤šç»„æ•°æ®å¯¹æ¯”ï¼ˆå¹´åº¦å¯¹æ¯”ã€ç«å“å¯¹æ¯”ï¼‰

* ç»Ÿè®¡æŒ‡æ ‡å±•ç¤ºï¼ˆå¢é•¿ç‡ã€å æ¯”ï¼‰

* è°ƒæŸ¥ç»“æœæ±‡æ€»

* æ€§èƒ½å‚æ•°å¯¹æ¯”

#### 
3. æ•°æ®æ ‡æ³¨
* è¡¨æ ¼ä¸‹æ–¹æ ‡æ³¨æ•°æ®æ¥æº
* å¦‚æœ‰ä¼°ç®—ï¼Œæ ‡æ³¨â€œ*â€å¹¶è¯´æ˜
```text

---

## å…­ã€æ ¸å¿ƒæµç¨‹è¯¦è§£

### 6.1 æ­£å¸¸å†™ä½œæµç¨‹

```plain
ç”¨æˆ·ï¼šå¸®æˆ‘å†™ä¸€ä»½å…³äº"AIåŒ»ç–—"çš„æŠ¥å‘Š
  â†“
å‰ç«¯ POST /api/conversations â†’ è¿”å› thread_id
  â†“
å‰ç«¯ WebSocket è¿æ¥ ws://.../ws/{thread_id}
  â†“
å‘é€ï¼š{"action": "start", "payload": {"title": "AIåŒ»ç–—æŠ¥å‘Š"}}
  â†“
åç«¯ ConversationService.start()
  â”œâ”€ åŠ è½½/åˆ›å»ºçŠ¶æ€
  â”œâ”€ Graph.run(plan_node)
  â”‚   â”œâ”€ AgentåŠ è½½ report-writing Skill
  â”‚   â”œâ”€ æ ¹æ®Skillè§„åˆ’å¤§çº²
  â”‚   â””â”€ è¿”å› interrupt äº‹ä»¶
  â””â”€ æ¨é€: {"type": "interrupt", "question": "å¤§çº²æ»¡æ„å—ï¼Ÿ"}
  â†“
å‰ç«¯æ˜¾ç¤ºå¤§çº² + ç¡®è®¤æŒ‰é’®
  â†“
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤"
  â†“
å‘é€ï¼š{"action": "feedback", "payload": {"feedback": "ç¡®è®¤"}}
  â†“
åç«¯ submit_feedback()
  â”œâ”€ Graph.run(write_section_node)
  â”‚   â”œâ”€ AgentåŠ è½½ tool-usage-strategy Skill
  â”‚   â”œâ”€ åˆ¤æ–­æ˜¯å¦éœ€è¦æœç´¢ â†’ è°ƒç”¨ MCP search-server
  â”‚   â”œâ”€ æ¥æ”¶ task_idï¼Œå¼€å§‹è½®è¯¢è¿›åº¦
  â”‚   â””â”€ æµå¼ç”Ÿæˆå†…å®¹
  â””â”€ æ¨é€: 
      â”œâ”€ {"type": "task_progress", "progress": 0.3, "message": "æœç´¢ç¬¬2é¡µ"}
      â”œâ”€ {"type": "stream_chunk", "content": "2024å¹´..."}
      â””â”€ {"type": "interrupt", "question": "ç¬¬1æ®µå®Œæˆï¼Œæ»¡æ„å—ï¼Ÿ"}
  â†“
ï¼ˆå¾ªç¯ç›´åˆ°å…¨éƒ¨å®Œæˆï¼‰
```

### 6.2 ä¿®æ”¹å·²ç¡®è®¤æ®µè½
```plain
ç”¨æˆ·åœ¨çœ‹ç¬¬3æ®µæ—¶ï¼Œæƒ³ä¿®æ”¹ç¬¬1æ®µ
  â†“
ç‚¹å‡»ç¬¬1æ®µçš„ã€ä¿®æ”¹ã€‘æŒ‰é’®ï¼Œè¾“å…¥"å¢åŠ 2024å¹´æ•°æ®"
  â†“
å‘é€ï¼š{"action": "edit_section", "payload": {"section_id": "sec-1", "instruction": "å¢åŠ 2024å¹´æ•°æ®"}}
  â†“
åç«¯ ConversationService.edit_section()
  â”œâ”€ æš‚åœå½“å‰å†™ä½œï¼ˆä¿å­˜ paused_section_idï¼‰
  â”œâ”€ æ ‡è®°è¦ä¿®æ”¹çš„æ®µè½ï¼ˆedit_target_idï¼‰
  â”œâ”€ Graph.run(edit_section_node)
  â”‚   â”œâ”€ AgentåŠ è½½ data-presentation Skill
  â”‚   â”œâ”€ æ ¹æ®æŒ‡ä»¤ä¿®æ”¹å†…å®¹
  â”‚   â””â”€ è¿”å›ä¿®æ”¹åçš„æ®µè½
  â””â”€ æ¨é€: 
      â”œâ”€ {"type": "stream_chunk", "content": "ä¿®æ”¹åå†…å®¹..."}
      â””â”€ {"type": "interrupt", "question": "ä¿®æ”¹å®Œæˆï¼Œæ»¡æ„å—ï¼Ÿ"}
  â†“
ç”¨æˆ·ç¡®è®¤åï¼Œæ¢å¤ä¹‹å‰æš‚åœçš„æ®µè½
```
### 6.3 æ–­çº¿é‡è¿æµç¨‹

```plain
ç½‘ç»œæ–­å¼€ â†’ WebSocketå…³é—­
  â†“
ï¼ˆå‡ ç§’åï¼‰å‰ç«¯é‡è¿ ws://.../ws/{thread_id}
  â†“
åç«¯ SessionManager.connect()
  â”œâ”€ è¸¢æ‰æ—§è¿æ¥ï¼ˆå¦‚æœ‰ï¼‰
  â”œâ”€ ä» ConversationStore åŠ è½½æœ€æ–°çŠ¶æ€
  â””â”€ ä» TaskStore åŠ è½½è¿›è¡Œä¸­çš„ä»»åŠ¡
  â†“
æ¨é€ï¼š{
  "type": "sync",
  "data": {
    "phase": "writing",
    "sections": [...],
    "current_section_id": "sec-2",
    "pending_tasks": [{"task_id": "task_123", "progress": 0.5}],
    "pending_question": "ç¬¬1æ®µå®Œæˆï¼Œæ‚¨æ»¡æ„å—ï¼Ÿ"
  }
}
  â†“
å‰ç«¯æ¢å¤ç•Œé¢ï¼Œç»§ç»­æ¥æ”¶è¿›åº¦
```

## ä¸ƒã€é¡¹ç›®ç›®å½•ç»“æ„

```text
project-root/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ main.py                 # FastAPI å…¥å£
â”‚   â”œâ”€â”€ dependencies.py         # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ conversation_controller.py
â”‚   â”‚   â”œâ”€â”€ websocket_controller.py
â”‚   â”‚   â””â”€â”€ upload_controller.py
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ conversation_service.py  # ä¸šåŠ¡ç¼–æ’
â”‚       â”œâ”€â”€ task_service.py          # MCPä»»åŠ¡ç®¡ç†
â”‚       â””â”€â”€ export_service.py        # æ–‡æ¡£å¯¼å‡º
â”‚
â”œâ”€â”€ graph/
â”‚   â”œâ”€â”€ graph.py                 # ConversationGraph
â”‚   â”œâ”€â”€ edges.py                 # çŠ¶æ€è·¯ç”±
â”‚   â”œâ”€â”€ nodes/
â”‚   â”‚   â”œâ”€â”€ plan.py
â”‚   â”‚   â”œâ”€â”€ plan_review.py
â”‚   â”‚   â”œâ”€â”€ write_section.py
â”‚   â”‚   â”œâ”€â”€ section_review.py
â”‚   â”‚   â”œâ”€â”€ edit_section.py
â”‚   â”‚   â””â”€â”€ complete.py
â”‚   â””â”€â”€ agents/
â”‚       â”œâ”€â”€ report_agent.py      # Agno Agent
â”‚       â””â”€â”€ mcp_client.py        # MCPå®¢æˆ·ç«¯
â”‚
â”œâ”€â”€ mcp/
â”‚   â”œâ”€â”€ client/
â”‚   â”‚   â”œâ”€â”€ client.py            # MCPè¿æ¥ç®¡ç†
â”‚   â”‚   â””â”€â”€ tools.py             # å·¥å…·è°ƒç”¨å°è£…
â”‚   â””â”€â”€ servers/                  # ç‹¬ç«‹éƒ¨ç½²
â”‚       â”œâ”€â”€ search-server/
â”‚       â”‚   â”œâ”€â”€ server.py
â”‚       â”‚   â””â”€â”€ requirements.txt
â”‚       â”œâ”€â”€ parse-server/
â”‚       â”‚   â”œâ”€â”€ server.py
â”‚       â”‚   â””â”€â”€ requirements.txt
â”‚       â””â”€â”€ analyze-server/
â”‚           â”œâ”€â”€ server.py
â”‚           â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ state.py                 # ConversationState
â”‚   â”œâ”€â”€ events.py                # WebSocketäº‹ä»¶
â”‚   â””â”€â”€ task.py                  # MCPä»»åŠ¡æ¨¡å‹
â”‚
â”œâ”€â”€ store/
â”‚   â”œâ”€â”€ storage.py               # ConversationStore
â”‚   â”œâ”€â”€ session.py               # SessionManager
â”‚   â””â”€â”€ task_store.py            # TaskStore (Redis)
â”‚
â”œâ”€â”€ skills/                       # AIè¡Œä¸ºè§„èŒƒï¼ˆéä»£ç ï¼‰
â”‚   â”œâ”€â”€ report-writing/
â”‚   â”‚   â””â”€â”€ SKILL.md
â”‚   â”œâ”€â”€ tool-usage-strategy/
â”‚   â”‚   â””â”€â”€ SKILL.md
â”‚   â””â”€â”€ data-presentation/
â”‚       â””â”€â”€ SKILL.md
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py              # ç¯å¢ƒå˜é‡
â”‚   â””â”€â”€ logging.py               # æ—¥å¿—é…ç½®
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ helpers.py               # é€šç”¨å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ data/                          # SQLiteæ•°æ®
â”‚   â””â”€â”€ conversations.db
â”‚
â”œâ”€â”€ .env                           # ç¯å¢ƒé…ç½®
â”œâ”€â”€ docker-compose.yml             # MCPæœåŠ¡ç¼–æ’
â””â”€â”€ requirements.txt               # ä¸»åº”ç”¨ä¾èµ–
```
## å…«ã€éƒ¨ç½²è¯´æ˜
### 8.1 ç¯å¢ƒå˜é‡
```env

# åº”ç”¨é…ç½®
APP_ENV=development
DEBUG=true
PORT=8000

# æ•°æ®åº“
DATABASE_URL=sqlite:///data/conversations.db

# Redisï¼ˆç”¨äºMCPä»»åŠ¡æŒä¹…åŒ–ï¼‰
REDIS_URL=redis://localhost:6379

# MCPæœåŠ¡é…ç½®
MCP_SERVERS=[
    {"name": "search", "url": "http://localhost:8001/mcp"},
    {"name": "parse", "url": "http://localhost:8002/mcp"},
    {"name": "analyze", "url": "http://localhost:8003/mcp"}
]

# LLMé…ç½®
OPENAI_API_KEY=sk-xxx
DASHSCOPE_API_KEY=sk-xxx
```

### 8.2 å¯åŠ¨é¡ºåº
```bash
# 1. å¯åŠ¨Redis
docker run -d -p 6379:6379 redis:7-alpine

# 2. å¯åŠ¨MCPæœåŠ¡é›†ç¾¤
cd mcp/servers/search-server && python server.py &
cd mcp/servers/parse-server && python server.py &
cd mcp/servers/analyze-server && python server.py &

# 3. å¯åŠ¨ä¸»åº”ç”¨
python api/main.py

# 4. å¯åŠ¨TaskServiceè½®è¯¢ï¼ˆå¯é€‰åå°ä»»åŠ¡ï¼‰
python -m api.services.task_service
```

## ä¹ã€æ ¸å¿ƒåŸåˆ™æ€»ç»“

| åŸåˆ™ | è¯´æ˜ |
| :--- | :--- |
| çŠ¶æ€é©±åŠ¨ | æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åŸºäº ConversationState ä¸å¯å˜æ›´æ–° |
| æœåŠ¡è§£è€¦ | MCPæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œé€šè¿‡æ ‡å‡†åè®®é€šä¿¡ |
| Skillå³è§„èŒƒ | AIè¡Œä¸ºè§„èŒƒæ”¾åœ¨Skillä¸­ï¼ŒæŒ‰éœ€åŠ è½½ï¼Œéä»£ç  |
| è¿›åº¦å¯è§ | æ‰€æœ‰è€—æ—¶æ“ä½œé€šè¿‡ task_progress æ¨é€ |
| å¯æ¢å¤æ€§ | ä¸šåŠ¡çŠ¶æ€å­˜SQLiteï¼Œä»»åŠ¡çŠ¶æ€å­˜Redis |
| ç”¨æˆ·æ§åˆ¶ | å¯éšæ—¶ç¡®è®¤/ä¿®æ”¹/é‡å†™ä»»ä½•æ®µè½ |

è¿™ä»½éœ€æ±‚æ–‡æ¡£æ˜ç¡®äº†ï¼š
* Agnoï¼šè´Ÿè´£æµç¨‹ç¼–æ’ã€å·¥å…·è°ƒç”¨å†³ç­–
* FastMCPï¼šè´Ÿè´£è€—æ—¶å·¥å…·çš„ç‹¬ç«‹æœåŠ¡å’Œè¿›åº¦æ¨é€
* Skillsï¼šè´Ÿè´£AIçš„è¡Œä¸ºè§„èŒƒã€å·¥å…·ä½¿ç”¨ç­–ç•¥
* ä¸‰å±‚å­˜å‚¨ï¼šä¸šåŠ¡çŠ¶æ€(SQLite) + ä»»åŠ¡çŠ¶æ€(Redis) + ä¼šè¯è®°å¿†(Agno DB)
å„éƒ¨åˆ†èŒè´£æ¸…æ™°ï¼Œå¯ä»¥æ®æ­¤å¼€å§‹è¯¦ç»†è®¾è®¡å’Œå¼€å‘ã€‚