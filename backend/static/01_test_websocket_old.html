<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæŠ¥å‘Šå†™ä½œç³»ç»Ÿ - WebSocketæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .left-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .right-panel {
            flex: 2;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .user-message {
            background-color: #e3f2fd;
            text-align: right;
        }
        .assistant-message {
            background-color: #f1f8e9;
        }
        .system-message {
            background-color: #fff3e0;
            font-style: italic;
        }
        .chunk-message {
            background-color: #e8eaf6;
            border-left: 3px solid #3f51b5;
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            border-left: 3px solid #c62828;
        }
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }
        .message-content {
            word-wrap: break-word;
        }
        .event-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }
        .event-type-sync { background-color: #e1f5fe; color: #01579b; }
        .event-type-chunk { background-color: #e8f5e8; color: #1b5e20; }
        .event-type-complete { background-color: #fff9c4; color: #f57f17; }
        .event-type-error { background-color: #ffcdd2; color: #b71c1c; }
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .stat-item {
            font-size: 14px;
        }
        .stat-label {
            font-weight: bold;
            color: #495057;
        }
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– AIæŠ¥å‘Šå†™ä½œç³»ç»Ÿ - WebSocketæµ‹è¯•</h1>
    
    <div class="container">
        <div class="left-panel">
            <h2>è¿æ¥è®¾ç½®</h2>
            <div class="form-group">
                <label for="threadId">å¯¹è¯ID (thread_id):</label>
                <input type="text" id="threadId" value="test-123" placeholder="è¾“å…¥å¯¹è¯ID">
            </div>
            
            <div class="form-group">
                <label>è¿æ¥çŠ¶æ€:</label>
                <div id="connectionStatus" class="status disconnected">æœªè¿æ¥</div>
            </div>
            
            <button id="connectBtn" class="secondary">ğŸ”Œ è¿æ¥</button>
            <button id="disconnectBtn" class="danger" disabled>âŒ æ–­å¼€</button>
            
            <div class="stats" id="connectionStats">
                <div class="stat-item"><span class="stat-label">è¿æ¥æ•°:</span> <span id="activeConnections">-</span></div>
                <div class="stat-item"><span class="stat-label">AgentçŠ¶æ€:</span> <span id="agentStatus">-</span></div>
            </div>
            
            <h2 style="margin-top: 30px;">å‘é€æ¶ˆæ¯</h2>
            <div class="form-group">
                <label for="messageType">æ¶ˆæ¯ç±»å‹:</label>
                <select id="messageType">
                    <option value="ping">PING (å¿ƒè·³)</option>
                    <option value="start">START (å¼€å§‹å¯¹è¯)</option>
                    <option value="message" selected>MESSAGE (å‘é€æ¶ˆæ¯)</option>
                    <option value="cancel">CANCEL (å–æ¶ˆ)</option>
                </select>
            </div>
            
            <div id="startFields" style="display: none;">
                <div class="form-group">
                    <label for="startTitle">å¯¹è¯æ ‡é¢˜:</label>
                    <input type="text" id="startTitle" value="æ–°æŠ¥å‘Š" placeholder="è¾“å…¥å¯¹è¯æ ‡é¢˜">
                </div>
            </div>
            
            <div id="messageFields">
                <div class="form-group">
                    <label for="messageContent">æ¶ˆæ¯å†…å®¹:</label>
                    <textarea id="messageContent" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹...">å¸®æˆ‘å†™ä¸€ä»½å…³äºäººå·¥æ™ºèƒ½å‘å±•æŠ¥å‘Š</textarea>
                </div>
                <div class="form-group">
                    <label for="replyTo">å›å¤ç›®æ ‡ (å¯é€‰):</label>
                    <input type="text" id="replyTo" placeholder="æ¶ˆæ¯ID">
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="sendBtn" disabled>ğŸ“¤ å‘é€</button>
                <button id="clearMessagesBtn" class="secondary">ğŸ—‘ï¸ æ¸…ç©ºæ¶ˆæ¯</button>
            </div>
            
            <div class="form-group">
                <label>å¿«é€Ÿæµ‹è¯•:</label>
                <button id="testPingBtn" disabled>ğŸ“ å‘é€Ping</button>
                <button id="testStartBtn" disabled>ğŸš€ å‘é€Start</button>
            </div>
        </div>
        
        <div class="right-panel">
            <h2>æ¶ˆæ¯æ—¥å¿—</h2>
            <div id="messages" class="messages">
                <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
            
            <div class="stats">
                <div class="stat-item"><span class="stat-label">æ€»æ¶ˆæ¯:</span> <span id="totalMessages">0</span></div>
                <div class="stat-item"><span class="stat-label">æœ€åæ´»åŠ¨:</span> <span id="lastActivity">-</span></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;
        let currentThreadId = '';
        
        // DOM å…ƒç´ 
        const threadIdInput = document.getElementById('threadId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const clearMessagesBtn = document.getElementById('clearMessagesBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const messagesDiv = document.getElementById('messages');
        const totalMessagesSpan = document.getElementById('totalMessages');
        const lastActivitySpan = document.getElementById('lastActivity');
        const messageType = document.getElementById('messageType');
        const startFields = document.getElementById('startFields');
        const messageFields = document.getElementById('messageFields');
        const startTitle = document.getElementById('startTitle');
        const messageContent = document.getElementById('messageContent');
        const replyTo = document.getElementById('replyTo');
        const testPingBtn = document.getElementById('testPingBtn');
        const testStartBtn = document.getElementById('testStartBtn');
        const activeConnectionsSpan = document.getElementById('activeConnections');
        const agentStatusSpan = document.getElementById('agentStatus');
        
        // æ¶ˆæ¯ç±»å‹åˆ‡æ¢
        messageType.addEventListener('change', function() {
            const type = this.value;
            startFields.style.display = type === 'start' ? 'block' : 'none';
            messageFields.style.display = type === 'message' ? 'block' : 'none';
        });
        
        // è¿æ¥
        connectBtn.addEventListener('click', connect);
        
        // æ–­å¼€
        disconnectBtn.addEventListener('click', disconnect);
        
        // å‘é€æ¶ˆæ¯
        sendBtn.addEventListener('click', sendMessage);
        
        // æ¸…ç©ºæ¶ˆæ¯
        clearMessagesBtn.addEventListener('click', clearMessages);
        
        // æµ‹è¯•æŒ‰é’®
        testPingBtn.addEventListener('click', () => sendPing());
        testStartBtn.addEventListener('click', () => sendStart());
        
        // è¿æ¥å‡½æ•°
        function connect() {
            const threadId = threadIdInput.value.trim();
            if (!threadId) {
                alert('è¯·è¾“å…¥å¯¹è¯ID');
                return;
            }
            
            currentThreadId = threadId;
            const wsUrl = `ws://${window.location.host}/ws/${threadId}`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    updateConnectionStatus(true);
                    addSystemMessage('ğŸ”Œ è¿æ¥å·²å»ºç«‹', `å¯¹è¯ID: ${threadId}`);
                    fetchStatus();
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleIncomingMessage(data);
                    } catch (e) {
                        addErrorMessage('è§£ææ¶ˆæ¯å¤±è´¥', event.data);
                    }
                };
                
                ws.onclose = function(event) {
                    updateConnectionStatus(false);
                    addSystemMessage('ğŸ”Œ è¿æ¥å·²å…³é—­', `ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æ­£å¸¸å…³é—­'}`);
                };
                
                ws.onerror = function(error) {
                    addErrorMessage('WebSocketé”™è¯¯', error);
                };
                
            } catch (e) {
                addErrorMessage('è¿æ¥å¤±è´¥', e.message);
            }
        }
        
        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = 'status connected';
                connectionStatus.textContent = 'å·²è¿æ¥';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                testPingBtn.disabled = false;
                testStartBtn.disabled = false;
            } else {
                connectionStatus.className = 'status disconnected';
                connectionStatus.textContent = 'æœªè¿æ¥';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
                testPingBtn.disabled = true;
                testStartBtn.disabled = true;
            }
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocketæœªè¿æ¥');
                return;
            }
            
            const type = messageType.value;
            let message = { type: type };
            
            switch(type) {
                case 'ping':
                    message.data = { timestamp: new Date().toISOString() };
                    break;
                    
                case 'start':
                    message.data = {
                        title: startTitle.value || 'æ–°å¯¹è¯',
                        context: {}
                    };
                    break;
                    
                case 'message':
                    const content = messageContent.value.trim();
                    if (!content) {
                        alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                        return;
                    }
                    message.data = {
                        content: content,
                        reply_to: replyTo.value || null
                    };
                    break;
                    
                case 'cancel':
                    message.data = {};
                    break;
            }
            
            // æ·»åŠ è¯·æ±‚IDç”¨äºè·Ÿè¸ª
            message.request_id = generateRequestId();
            
            ws.send(JSON.stringify(message));
            addSentMessage(type, message.data, message.request_id);
            
            // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
            updateLastActivity();
        }
        
        // å‘é€Ping
        function sendPing() {
            messageType.value = 'ping';
            sendMessage();
        }
        
        // å‘é€Start
        function sendStart() {
            messageType.value = 'start';
            sendMessage();
        }
        
        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleIncomingMessage(data) {
            const type = data.type;
            const eventData = data.data || {};
            const timestamp = data.timestamp || new Date().toISOString();
            const requestId = data.request_id;
            
            let title = '';
            let content = '';
            
            switch(type) {
                case 'sync':
                    title = `ğŸ”„ åŒæ­¥ [${eventData.type || 'unknown'}]`;
                    content = JSON.stringify(eventData, null, 2);
                    addMessage('system', title, content, timestamp, 'sync');
                    break;
                    
                case 'chunk':
                    title = `ğŸ“ æµå¼å— [${eventData.message_id || 'unknown'}]`;
                    content = eventData.text || '';
                    addMessage('chunk', title, content, timestamp, 'chunk');
                    break;
                    
                case 'complete':
                    title = `âœ… å®Œæˆ [${eventData.message_id}]`;
                    content = `å®Œæ•´å†…å®¹: ${eventData.full_content}\nå…ƒæ•°æ®: ${JSON.stringify(eventData.metadata || {})}`;
                    addMessage('assistant', title, content, timestamp, 'complete');
                    break;
                    
                case 'error':
                    title = `âŒ é”™è¯¯ [${eventData.code}]`;
                    content = `${eventData.message}\n${JSON.stringify(eventData.details || {})}`;
                    addMessage('error', title, content, timestamp, 'error');
                    break;
                    
                case 'pong':
                    title = `ğŸ“ PONG`;
                    content = JSON.stringify(eventData, null, 2);
                    addMessage('system', title, content, timestamp, 'pong');
                    break;
                    
                default:
                    title = `ğŸ“¥ æœªçŸ¥ç±»å‹: ${type}`;
                    content = JSON.stringify(data, null, 2);
                    addMessage('system', title, content, timestamp, 'unknown');
            }
            
            messageCount++;
            totalMessagesSpan.textContent = messageCount;
            updateLastActivity();
        }
        
        // æ·»åŠ å‘é€çš„æ¶ˆæ¯åˆ°æ—¥å¿—
        function addSentMessage(type, data, requestId) {
            const title = `ğŸ“¤ å‘é€ [${type}]${requestId ? ' req:' + requestId : ''}`;
            const content = JSON.stringify(data, null, 2);
            addMessage('user', title, content, new Date().toISOString(), 'sent');
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(title, content) {
            addMessage('system', title, content, new Date().toISOString(), 'system');
        }
        
        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        function addErrorMessage(title, content) {
            addMessage('error', title, content, new Date().toISOString(), 'error');
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, title, content, timestamp, eventType) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const timeSpan = document.createElement('span');
            timeSpan.textContent = new Date(timestamp).toLocaleTimeString();
            
            const typeSpan = document.createElement('span');
            typeSpan.className = `event-type event-type-${eventType}`;
            typeSpan.textContent = eventType.toUpperCase();
            
            headerDiv.appendChild(typeSpan);
            headerDiv.appendChild(document.createTextNode(` ${title} `));
            headerDiv.appendChild(timeSpan);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // æ¸…ç©ºæ¶ˆæ¯
        function clearMessages() {
            messagesDiv.innerHTML = '';
            messageCount = 0;
            totalMessagesSpan.textContent = '0';
        }
        
        // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
        function updateLastActivity() {
            lastActivitySpan.textContent = new Date().toLocaleTimeString();
        }
        
        // ç”Ÿæˆè¯·æ±‚ID
        function generateRequestId() {
            return 'req_' + Math.random().toString(36).substr(2, 9);
        }
        
        // è·å–æœåŠ¡å™¨çŠ¶æ€
        async function fetchStatus() {
            try {
                const response = await fetch('/ws/status');
                const data = await response.json();
                activeConnectionsSpan.textContent = data.active_conversations || 0;
                agentStatusSpan.textContent = data.agent_ready ? 'å°±ç»ª' : 'æœªå°±ç»ª';
            } catch (e) {
                console.error('è·å–çŠ¶æ€å¤±è´¥', e);
            }
        }
        
        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(fetchStatus, 5000);
        
        // åˆå§‹è·å–çŠ¶æ€
        fetchStatus();
    </script>
</body>
</html>

<!-- âœ… æ–°åè®®çš„æ‰€æœ‰åŠŸèƒ½
PING/PONGï¼šå¿ƒè·³æµ‹è¯•

STARTï¼šå¼€å§‹æ–°å¯¹è¯

MESSAGEï¼šå‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒæµå¼å“åº”ï¼‰

CANCELï¼šå–æ¶ˆæ“ä½œï¼ˆé¢„ç•™ï¼‰

âœ… å¯è§†åŒ–ç‰¹æ€§
ä¸åŒé¢œè‰²åŒºåˆ†æ¶ˆæ¯ç±»å‹

æ˜¾ç¤ºäº‹ä»¶ç±»å‹æ ‡ç­¾

å®æ—¶ç»Ÿè®¡ä¿¡æ¯

è¿æ¥çŠ¶æ€æŒ‡ç¤º

æœåŠ¡å™¨çŠ¶æ€ç›‘æ§

âœ… ä½¿ç”¨è¯´æ˜
è¾“å…¥å¯¹è¯ID

ç‚¹å‡»"è¿æ¥"

é€‰æ‹©æ¶ˆæ¯ç±»å‹

å‘é€æ¶ˆæ¯

æŸ¥çœ‹æµå¼å“åº” -->