<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæŠ¥å‘Šå†™ä½œç³»ç»Ÿ - WebSocketæµ‹è¯•ï¼ˆæ–°ç‰ˆï¼‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-top: -5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .left-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .right-panel {
            flex: 2;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            height: 80px;
            resize: vertical;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.danger {
            background-color: #f44336;
        }

        button.danger:hover {
            background-color: #da190b;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        button.small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .messages {
            height: 450px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fafafa;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid transparent;
        }

        .user-message {
            background-color: #e3f2fd;
            border-left-color: #2196F3;
        }

        .assistant-message {
            background-color: #f1f8e9;
            border-left-color: #4CAF50;
        }

        .system-message {
            background-color: #fff3e0;
            border-left-color: #FF9800;
        }

        .error-message {
            background-color: #ffebee;
            border-left-color: #f44336;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .message-content {
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .event-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            background-color: #e0e0e0;
        }

        .event-type-sync {
            background-color: #e1f5fe;
            color: #01579b;
        }

        .event-type-chunk {
            background-color: #e8f5e8;
            color: #1b5e20;
        }

        .event-type-prompt {
            background-color: #fff9c4;
            color: #f57f17;
        }

        .event-type-section_ready {
            background-color: #d1c4e9;
            color: #311b92;
        }

        .event-type-section_updated {
            background-color: #b2ebf2;
            color: #006064;
        }

        .event-type-report_completed {
            background-color: #c8e6c9;
            color: #1b5e20;
        }

        .event-type-error {
            background-color: #ffcdd2;
            color: #b71c1c;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            flex-wrap: wrap;
        }

        .stat-item {
            font-size: 13px;
        }

        .stat-label {
            font-weight: bold;
            color: #495057;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-test {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #ddd;
        }

        .request-id {
            color: #999;
            font-size: 10px;
        }

        .timestamp {
            color: #999;
            font-size: 10px;
        }
    </style>
</head>

<body>
    <h1>ğŸ¤– AIæŠ¥å‘Šå†™ä½œç³»ç»Ÿ - WebSocketæµ‹è¯•ï¼ˆæ–°ç‰ˆï¼‰</h1>
    <div class="subtitle">ä½¿ç”¨çº¯æ•°æ®æ¨¡å‹ | äº‹ä»¶ç±»å‹: start/message/approve/edit_section/regenerate</div>

    <div class="container">
        <div class="left-panel">
            <h2>ğŸ”Œ è¿æ¥è®¾ç½®</h2>
            <div class="form-group">
                <label for="threadId">å¯¹è¯ID (thread_id):</label>
                <input type="text" id="threadId" value="test-123" placeholder="è¾“å…¥å¯¹è¯ID">
                <div style="margin-top: 5px; font-size: 12px; color: #666;">æ¯ä¸ªIDå¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è¯å®ä¾‹</div>
            </div>

            <div class="form-group">
                <label>è¿æ¥çŠ¶æ€:</label>
                <div id="connectionStatus" class="status disconnected">æœªè¿æ¥</div>
            </div>

            <button id="connectBtn" class="secondary">ğŸ”Œ è¿æ¥</button>
            <button id="disconnectBtn" class="danger" disabled>âŒ æ–­å¼€</button>

            <div class="stats" id="connectionStats">
                <div class="stat-item"><span class="stat-label">æ´»è·ƒå¯¹è¯:</span> <span id="activeConnections">-</span></div>
                <div class="stat-item"><span class="stat-label">AgentçŠ¶æ€:</span> <span id="agentStatus">-</span></div>
            </div>

            <h2 style="margin-top: 30px;">ğŸ“¤ å‘é€æ¶ˆæ¯</h2>
            <div class="form-group">
                <label for="messageType">æ¶ˆæ¯ç±»å‹:</label>
                <select id="messageType">
                    <option value="ping">PING (å¿ƒè·³æµ‹è¯•)</option>
                    <option value="start" selected>START (å¼€å§‹æ–°å¯¹è¯)</option>
                    <option value="message">MESSAGE (å‘é€æ¶ˆæ¯)</option>
                    <option value="approve">APPROVE (ç¡®è®¤å¤§çº²/æ®µè½)</option>
                    <option value="edit_section">EDIT_SECTION (ä¿®æ”¹æ®µè½)</option>
                    <option value="regenerate">REGENERATE (é‡å†™æ®µè½)</option>
                    <option value="cancel">CANCEL (å–æ¶ˆæ“ä½œ)</option>
                </select>
            </div>

            <!-- START å­—æ®µ -->
            <div id="startFields" style="display: none;">
                <div class="form-group">
                    <label for="startTitle">å¯¹è¯æ ‡é¢˜:</label>
                    <input type="text" id="startTitle" value="AIåŒ»ç–—æŠ¥å‘Š" placeholder="è¾“å…¥æŠ¥å‘Šæ ‡é¢˜">
                </div>
            </div>

            <!-- MESSAGE å­—æ®µ -->
            <div id="messageFields" style="display: block;">
                <div class="form-group">
                    <label for="messageContent">æ¶ˆæ¯å†…å®¹:</label>
                    <textarea id="messageContent" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹...">å¸®æˆ‘å†™ä¸€ä»½å…³äºäººå·¥æ™ºèƒ½åœ¨åŒ»ç–—é¢†åŸŸåº”ç”¨çš„æŠ¥å‘Š</textarea>
                </div>
                <div class="form-group">
                    <label for="replyTo">å›å¤ç›®æ ‡ (å¯é€‰):</label>
                    <input type="text" id="replyTo" placeholder="æ¶ˆæ¯ID">
                </div>
            </div>

            <!-- APPROVE/EDIT/REGENERATE å­—æ®µï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
            <div id="sectionFields" style="display: none;">
                <div class="form-group">
                    <label for="sectionId">æ®µè½ID:</label>
                    <input type="text" id="sectionId" placeholder="å¦‚: sec-1">
                </div>
                <div class="form-group" id="instructionField" style="display: none;">
                    <label for="instruction">ä¿®æ”¹æ„è§:</label>
                    <textarea id="instruction" placeholder="è¾“å…¥ä¿®æ”¹æ„è§..."></textarea>
                </div>
                <div class="form-group" id="feedbackField" style="display: none;">
                    <label for="feedback">åé¦ˆæ„è§ (å¯é€‰):</label>
                    <input type="text" id="feedback" placeholder="åé¦ˆæ„è§">
                </div>
            </div>

            <div class="action-buttons">
                <button id="sendBtn" disabled>ğŸ“¤ å‘é€</button>
                <button id="clearMessagesBtn" class="secondary">ğŸ—‘ï¸ æ¸…ç©ºæ¶ˆæ¯</button>
            </div>

            <div class="quick-test">
                <h3>âš¡ å¿«é€Ÿæµ‹è¯•æµç¨‹</h3>
                <button id="testPingBtn" class="small" disabled>1. æµ‹è¯•Ping</button>
                <button id="testStartBtn" class="small" disabled>2. å¼€å§‹æ–°å¯¹è¯</button>
                <button id="testApprovePlanBtn" class="small" disabled>3. ç¡®è®¤å¤§çº²</button>
                <button id="testMessageBtn" class="small" disabled>4. å‘é€æ¶ˆæ¯</button>
                <button id="testApproveSectionBtn" class="small" disabled>5. ç¡®è®¤æ®µè½</button>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    æç¤ºï¼šæŒ‰é¡ºåºç‚¹å‡»æµ‹è¯•å®Œæ•´æµç¨‹
                </div>
            </div>
        </div>

        <div class="right-panel">
            <h2>ğŸ“‹ æ¶ˆæ¯æ—¥å¿—</h2>
            <div id="messages" class="messages">
                <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>

            <div class="stats">
                <div class="stat-item"><span class="stat-label">æ€»æ¶ˆæ¯:</span> <span id="totalMessages">0</span></div>
                <div class="stat-item"><span class="stat-label">æœ€åæ´»åŠ¨:</span> <span id="lastActivity">-</span></div>
                <div class="stat-item"><span class="stat-label">å½“å‰é˜¶æ®µ:</span> <span id="currentPhase">-</span></div>
            </div>

            <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: right;">
                æ”¯æŒçš„äº‹ä»¶ç±»å‹: sync, chunk, complete, prompt, section_ready, section_updated, state_change, report_completed,
                task_progress, interrupt, error, pong
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;
        let currentThreadId = '';

        // DOM å…ƒç´ 
        const threadIdInput = document.getElementById('threadId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const clearMessagesBtn = document.getElementById('clearMessagesBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const messagesDiv = document.getElementById('messages');
        const totalMessagesSpan = document.getElementById('totalMessages');
        const lastActivitySpan = document.getElementById('lastActivity');
        const currentPhaseSpan = document.getElementById('currentPhase');
        const messageType = document.getElementById('messageType');
        const startFields = document.getElementById('startFields');
        const messageFields = document.getElementById('messageFields');
        const sectionFields = document.getElementById('sectionFields');
        const instructionField = document.getElementById('instructionField');
        const feedbackField = document.getElementById('feedbackField');

        // è¾“å…¥å­—æ®µ
        const startTitle = document.getElementById('startTitle');
        const messageContent = document.getElementById('messageContent');
        const replyTo = document.getElementById('replyTo');
        const sectionId = document.getElementById('sectionId');
        const instruction = document.getElementById('instruction');
        const feedback = document.getElementById('feedback');

        // æµ‹è¯•æŒ‰é’®
        const testPingBtn = document.getElementById('testPingBtn');
        const testStartBtn = document.getElementById('testStartBtn');
        const testApprovePlanBtn = document.getElementById('testApprovePlanBtn');
        const testMessageBtn = document.getElementById('testMessageBtn');
        const testApproveSectionBtn = document.getElementById('testApproveSectionBtn');

        // çŠ¶æ€æ˜¾ç¤º
        const activeConnectionsSpan = document.getElementById('activeConnections');
        const agentStatusSpan = document.getElementById('agentStatus');

        // æ¶ˆæ¯ç±»å‹åˆ‡æ¢
        messageType.addEventListener('change', function () {
            const type = this.value;

            // éšè—æ‰€æœ‰åŠ¨æ€å­—æ®µ
            startFields.style.display = 'none';
            messageFields.style.display = 'none';
            sectionFields.style.display = 'none';
            instructionField.style.display = 'none';
            feedbackField.style.display = 'none';

            // æ ¹æ®ç±»å‹æ˜¾ç¤ºå¯¹åº”å­—æ®µ
            if (type === 'start') {
                startFields.style.display = 'block';
            } else if (type === 'message') {
                messageFields.style.display = 'block';
            } else if (type === 'approve') {
                sectionFields.style.display = 'block';
                feedbackField.style.display = 'block';
            } else if (type === 'edit_section') {
                sectionFields.style.display = 'block';
                instructionField.style.display = 'block';
            } else if (type === 'regenerate') {
                sectionFields.style.display = 'block';
            }
        });

        // è¿æ¥
        connectBtn.addEventListener('click', connect);

        // æ–­å¼€
        disconnectBtn.addEventListener('click', disconnect);

        // å‘é€æ¶ˆæ¯
        sendBtn.addEventListener('click', sendMessage);

        // æ¸…ç©ºæ¶ˆæ¯
        clearMessagesBtn.addEventListener('click', clearMessages);

        // å¿«é€Ÿæµ‹è¯•æŒ‰é’®
        testPingBtn.addEventListener('click', () => sendPing());
        testStartBtn.addEventListener('click', () => sendStart());
        testApprovePlanBtn.addEventListener('click', () => sendApprovePlan());
        testMessageBtn.addEventListener('click', () => sendQuickMessage());
        testApproveSectionBtn.addEventListener('click', () => sendApproveSection('sec-1'));

        // è¿æ¥å‡½æ•°
        function connect() {
            const threadId = threadIdInput.value.trim();
            if (!threadId) {
                alert('è¯·è¾“å…¥å¯¹è¯ID');
                return;
            }

            currentThreadId = threadId;
            const wsUrl = `ws://${window.location.host}/ws/${threadId}`;

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    updateConnectionStatus(true);
                    addSystemMessage('ğŸ”Œ è¿æ¥å·²å»ºç«‹', `å¯¹è¯ID: ${threadId}`);
                    fetchStatus();

                    // è‡ªåŠ¨å‘é€ä¸€ä¸ªstartå¼€å§‹å¯¹è¯
                    setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            addSystemMessage('ğŸ’¡ æç¤º', 'ä½ å¯ä»¥ç‚¹å‡»"å¼€å§‹æ–°å¯¹è¯"æˆ–å‘é€æ¶ˆæ¯');
                        }
                    }, 500);
                };

                ws.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleIncomingMessage(data);
                    } catch (e) {
                        addErrorMessage('è§£ææ¶ˆæ¯å¤±è´¥', event.data);
                    }
                };

                ws.onclose = function (event) {
                    updateConnectionStatus(false);
                    addSystemMessage('ğŸ”Œ è¿æ¥å·²å…³é—­', `ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æ­£å¸¸å…³é—­'}`);
                };

                ws.onerror = function (error) {
                    addErrorMessage('WebSocketé”™è¯¯', 'è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨');
                };

            } catch (e) {
                addErrorMessage('è¿æ¥å¤±è´¥', e.message);
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = 'status connected';
                connectionStatus.textContent = 'å·²è¿æ¥';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                testPingBtn.disabled = false;
                testStartBtn.disabled = false;
                testApprovePlanBtn.disabled = false;
                testMessageBtn.disabled = false;
                testApproveSectionBtn.disabled = false;
            } else {
                connectionStatus.className = 'status disconnected';
                connectionStatus.textContent = 'æœªè¿æ¥';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
                testPingBtn.disabled = true;
                testStartBtn.disabled = true;
                testApprovePlanBtn.disabled = true;
                testMessageBtn.disabled = true;
                testApproveSectionBtn.disabled = true;
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocketæœªè¿æ¥');
                return;
            }

            const type = messageType.value;
            let message = { type: type };

            switch (type) {
                case 'ping':
                    message.data = { timestamp: new Date().toISOString() };
                    break;

                case 'start':
                    message.data = {
                        title: startTitle.value || 'æ–°å¯¹è¯',
                        context: {}
                    };
                    break;

                case 'message':
                    const content = messageContent.value.trim();
                    if (!content) {
                        alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                        return;
                    }
                    message.data = {
                        content: content,
                        reply_to: replyTo.value || null
                    };
                    break;

                case 'approve':
                    message.data = {
                        section_id: sectionId.value || undefined,
                        feedback: feedback.value || undefined
                    };
                    break;

                case 'edit_section':
                    if (!sectionId.value) {
                        alert('è¯·è¾“å…¥æ®µè½ID');
                        return;
                    }
                    message.data = {
                        section_id: sectionId.value,
                        instruction: instruction.value || 'è¯·ä¿®æ”¹è¿™æ®µå†…å®¹'
                    };
                    break;

                case 'regenerate':
                    if (!sectionId.value) {
                        alert('è¯·è¾“å…¥æ®µè½ID');
                        return;
                    }
                    message.data = {
                        section_id: sectionId.value
                    };
                    break;

                case 'cancel':
                    message.data = {};
                    break;
            }

            // æ·»åŠ è¯·æ±‚ID
            message.request_id = 'req_' + Math.random().toString(36).substr(2, 9);

            ws.send(JSON.stringify(message));
            addSentMessage(type, message.data, message.request_id);
            updateLastActivity();
        }

        // å¿«é€Ÿæµ‹è¯•å‡½æ•°
        function sendPing() {
            messageType.value = 'ping';
            messageType.dispatchEvent(new Event('change'));
            sendMessage();
        }

        function sendStart() {
            messageType.value = 'start';
            messageType.dispatchEvent(new Event('change'));
            sendMessage();
        }

        function sendApprovePlan() {
            messageType.value = 'approve';
            messageType.dispatchEvent(new Event('change'));
            sectionId.value = '';
            feedback.value = '';
            sendMessage();
        }

        function sendQuickMessage() {
            messageType.value = 'message';
            messageType.dispatchEvent(new Event('change'));
            messageContent.value = 'å¸®æˆ‘å†™ä¸€ä»½å…³äºAIåŒ»ç–—çš„æŠ¥å‘Š';
            sendMessage();
        }

        function sendApproveSection(sectionIdValue) {
            messageType.value = 'approve';
            messageType.dispatchEvent(new Event('change'));
            sectionId.value = sectionIdValue;
            feedback.value = '';
            sendMessage();
        }

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleIncomingMessage(data) {
            const type = data.type;
            const eventData = data.data || {};
            const timestamp = data.timestamp || new Date().toISOString();
            const requestId = data.request_id;

            let title = '';
            let content = '';
            let messageType_class = 'system';
            let eventClass = 'sync';

            // å°è¯•æ›´æ–°å½“å‰é˜¶æ®µ
            if (eventData.phase) {
                currentPhaseSpan.textContent = eventData.phase;
            }

            switch (type) {
                case 'sync':
                    title = `ğŸ”„ åŒæ­¥ [${eventData.type || 'unknown'}]`;

                    if (eventData.type === 'history' && eventData.messages) {
                        // æ˜¾ç¤ºæ‰€æœ‰å†å²æ¶ˆæ¯
                        content = `å…± ${eventData.total || eventData.messages.length} æ¡å†å²æ¶ˆæ¯:\n`;
                        eventData.messages.forEach(msg => {
                            const time = new Date(msg.created_at).toLocaleTimeString();
                            content += `\n[${time}] ${msg.role}: ${msg.content.substring(0, 50)}${msg.content.length > 50 ? '...' : ''}`;
                        });
                    } else {
                        content = JSON.stringify(eventData, null, 2);
                    }

                    addMessage('system', title, content, timestamp, 'sync');
                    break;

                case 'chunk':
                    title = `ğŸ“ æµå¼å—`;
                    content = `[${eventData.section_id || 'æœªçŸ¥æ®µè½'}]: ${eventData.text}`;
                    messageType_class = 'assistant';
                    eventClass = 'chunk';
                    break;

                case 'complete':
                    title = `âœ… å®Œæˆ [${eventData.message_id}]`;
                    content = `å®Œæ•´å†…å®¹: ${eventData.full_content ? eventData.full_content.substring(0, 150) + '...' : ''}`;
                    if (eventData.metadata) {
                        content += `\nå…ƒæ•°æ®: ${JSON.stringify(eventData.metadata)}`;
                    }
                    messageType_class = 'assistant';
                    eventClass = 'complete';
                    break;

                case 'prompt':
                    title = `â“ éœ€è¦ç¡®è®¤`;
                    content = `é—®é¢˜: ${eventData.question || ''}\né€‰é¡¹: ${(eventData.options || []).join(', ')}`;
                    if (eventData.context) {
                        content += `\nä¸Šä¸‹æ–‡: ${JSON.stringify(eventData.context)}`;
                    }
                    eventClass = 'prompt';
                    break;

                case 'section_ready':
                    title = `ğŸ“„ æ®µè½å°±ç»ª [${eventData.section_id}]`;
                    content = `æ ‡é¢˜: ${eventData.title || ''}\n`;
                    content += `å†…å®¹: ${eventData.content ? eventData.content.substring(0, 150) + '...' : ''}\n`;
                    content += `é—®é¢˜: ${eventData.question || ''}\né€‰é¡¹: ${(eventData.options || []).join(', ')}`;
                    eventClass = 'section_ready';
                    break;

                case 'section_updated':
                    title = `âœï¸ æ®µè½å·²æ›´æ–° [${eventData.section_id}]`;
                    content = `ç‰ˆæœ¬: ${eventData.version || 1}\n`;
                    content += `çŠ¶æ€: ${eventData.status || ''}\n`;
                    content += `æ–°å†…å®¹: ${eventData.content ? eventData.content.substring(0, 150) + '...' : ''}`;
                    eventClass = 'section_updated';
                    break;

                case 'state_change':
                    title = `ğŸ”„ çŠ¶æ€å˜æ›´`;
                    content = `æ–°é˜¶æ®µ: ${eventData.phase || 'unknown'}`;
                    if (eventData.current_section) {
                        content += `\nå½“å‰æ®µè½: ${eventData.current_section}`;
                    }
                    eventClass = 'state_change';
                    break;

                case 'report_completed':
                    title = `ğŸ‰ æŠ¥å‘Šå®Œæˆ`;
                    content = `æ€»æ®µè½: ${eventData.total_sections || 0}\n`;
                    content += `æ€»å­—æ•°: ${eventData.total_words || 0}\n`;
                    content += `å¯å¯¼å‡ºæ ¼å¼: ${(eventData.export_formats || []).join(', ')}`;
                    eventClass = 'report_completed';
                    break;

                case 'task_progress':
                    title = `â³ ä»»åŠ¡è¿›åº¦ [${eventData.task_id}]`;
                    content = `${Math.round((eventData.progress || 0) * 100)}% - ${eventData.message || ''}`;
                    if (eventData.status) {
                        content += `\nçŠ¶æ€: ${eventData.status}`;
                    }
                    eventClass = 'task_progress';
                    break;

                case 'interrupt':
                    title = `âš ï¸ éœ€è¦ä»‹å…¥`;
                    content = `åŸå› : ${eventData.reason || ''}`;
                    if (eventData.question) content += `\né—®é¢˜: ${eventData.question}`;
                    if (eventData.options) content += `\né€‰é¡¹: ${eventData.options.join(', ')}`;
                    if (eventData.section_id) content += `\næ®µè½: ${eventData.section_id}`;
                    eventClass = 'interrupt';
                    break;

                case 'error':
                    title = `âŒ é”™è¯¯ [${eventData.code}]`;
                    content = eventData.message || '';
                    if (eventData.details) {
                        content += `\nè¯¦æƒ…: ${JSON.stringify(eventData.details)}`;
                    }
                    messageType_class = 'error';
                    eventClass = 'error';
                    break;

                case 'pong':
                    title = `ğŸ“ PONG`;
                    content = `æœåŠ¡å™¨æ—¶é—´: ${eventData.timestamp || ''}`;
                    if (eventData.echo) {
                        content += `\nå›æ˜¾: ${JSON.stringify(eventData.echo)}`;
                    }
                    eventClass = 'pong';
                    break;

                default:
                    title = `ğŸ“¥ æœªçŸ¥ç±»å‹: ${type}`;
                    content = JSON.stringify(data, null, 2);
                    eventClass = 'unknown';
            }

            // æ·»åŠ æ—¶é—´æˆ³å’Œè¯·æ±‚IDåˆ°å†…å®¹
            if (requestId) {
                content += `\n\nè¯·æ±‚ID: ${requestId}`;
            }
            content += `\næ—¶é—´: ${new Date(timestamp).toLocaleTimeString()}`;

            addMessage(messageType_class, title, content, timestamp, eventClass);

            messageCount++;
            totalMessagesSpan.textContent = messageCount;
            updateLastActivity();
        }

        // æ·»åŠ å‘é€çš„æ¶ˆæ¯åˆ°æ—¥å¿—
        function addSentMessage(type, data, requestId) {
            const title = `ğŸ“¤ å‘é€ [${type}]`;
            let content = JSON.stringify(data, null, 2);
            if (requestId) {
                content += `\n\nè¯·æ±‚ID: ${requestId}`;
            }
            addMessage('user', title, content, new Date().toISOString(), 'sent');
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(title, content) {
            addMessage('system', title, content, new Date().toISOString(), 'system');
        }

        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        function addErrorMessage(title, content) {
            addMessage('error', title, content, new Date().toISOString(), 'error');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, title, content, timestamp, eventType) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';

            const leftSpan = document.createElement('span');

            const typeSpan = document.createElement('span');
            typeSpan.className = `event-type event-type-${eventType}`;
            typeSpan.textContent = eventType.toUpperCase();

            leftSpan.appendChild(typeSpan);
            leftSpan.appendChild(document.createTextNode(` ${title}`));

            const timeSpan = document.createElement('span');
            timeSpan.className = 'timestamp';
            timeSpan.textContent = new Date(timestamp).toLocaleTimeString();

            headerDiv.appendChild(leftSpan);
            headerDiv.appendChild(timeSpan);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;

            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // æ¸…ç©ºæ¶ˆæ¯
        function clearMessages() {
            messagesDiv.innerHTML = '';
            messageCount = 0;
            totalMessagesSpan.textContent = '0';
            currentPhaseSpan.textContent = '-';
        }

        // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
        function updateLastActivity() {
            lastActivitySpan.textContent = new Date().toLocaleTimeString();
        }

        // è·å–æœåŠ¡å™¨çŠ¶æ€
        async function fetchStatus() {
            try {
                const response = await fetch('/ws/status');
                const data = await response.json();
                activeConnectionsSpan.textContent = data.active_conversations || 0;
                agentStatusSpan.textContent = data.agent_ready ? 'å°±ç»ª' : 'æœªå°±ç»ª';
            } catch (e) {
                console.error('è·å–çŠ¶æ€å¤±è´¥', e);
            }
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(fetchStatus, 5000);

        // åˆå§‹è·å–çŠ¶æ€
        fetchStatus();
    </script>
</body>

</html>