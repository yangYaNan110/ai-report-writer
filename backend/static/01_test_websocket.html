<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæŠ¥å‘Šå†™ä½œåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1e1e2f;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background-color: #2d2d3f;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #e0e0e0;
        }

        /* å¤´éƒ¨ */
        .header {
            padding: 16px 24px;
            background-color: #36364b;
            border-bottom: 1px solid #4a4a60;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-area {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .thread-input {
            background-color: #2d2d3f;
            border: 1px solid #4a4a60;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            width: 200px;
        }

        .thread-input:focus {
            outline: none;
            border-color: #6c5ce7;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #6c5ce7;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5b4bc4;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            background-color: #2d2d3f;
            border: 1px solid #4a4a60;
        }

        .status-connected {
            color: #2ecc71;
        }

        .status-disconnected {
            color: #e74c3c;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* å·¦ä¾§ - å¯¹è¯å†å² */
        .chat-history {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #4a4a60;
            background-color: #2d2d3f;
        }

        .history-header {
            padding: 16px;
            border-bottom: 1px solid #4a4a60;
            font-weight: 500;
            color: #a0a0c0;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* å³ä¾§ - æŠ¥å‘Šé¢„è§ˆ */
        .report-preview {
            width: 40%;
            background-color: #252536;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 16px;
            border-bottom: 1px solid #4a4a60;
            font-weight: 500;
            color: #a0a0c0;
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .user-message {
            background-color: #6c5ce7;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .assistant-message {
            background-color: #36364b;
            color: #e0e0e0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #4a4a60;
        }

        .system-message {
            background-color: #2d2d3f;
            color: #a0a0c0;
            align-self: center;
            font-size: 13px;
            border: 1px dashed #4a4a60;
        }

        .message-time {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        .user-time {
            text-align: right;
        }

        /* å¤§çº²å¡ç‰‡ */
        .outline-card {
            background-color: #2d2d3f;
            border: 1px solid #6c5ce7;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
        }

        .outline-title {
            color: #6c5ce7;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .outline-item {
            padding: 8px 12px;
            margin: 4px 0;
            background-color: #36364b;
            border-radius: 4px;
            border-left: 3px solid #6c5ce7;
        }

        /* ç¡®è®¤æ¡† */
        .confirmation-box {
            background-color: #36364b;
            border: 1px solid #6c5ce7;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            align-self: center;
            width: 100%;
        }

        .confirmation-question {
            color: #fff;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .confirmation-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .option-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .option-confirm {
            background-color: #2ecc71;
            color: white;
        }

        .option-edit {
            background-color: #f39c12;
            color: white;
        }

        .option-regenerate {
            background-color: #9b59b6;
            color: white;
        }

        .option-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        /* æµå¼è¾“å‡º */
        .streaming-message {
            border-left: 3px solid #6c5ce7;
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 18px;
            background-color: #6c5ce7;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* è¾“å…¥åŒº */
        .input-area {
            padding: 16px;
            background-color: #36364b;
            border-top: 1px solid #4a4a60;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            background-color: #2d2d3f;
            border: 1px solid #4a4a60;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            max-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #6c5ce7;
        }

        textarea::placeholder {
            color: #666;
        }

        .send-btn {
            padding: 12px 24px;
            background-color: #6c5ce7;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .send-btn:hover {
            background-color: #5b4bc4;
        }

        .send-btn:disabled {
            background-color: #4a4a60;
            cursor: not-allowed;
        }

        /* æ¬¢è¿ç•Œé¢ */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
            color: #a0a0c0;
        }

        .welcome-title {
            font-size: 28px;
            color: #fff;
            margin-bottom: 16px;
        }

        .examples {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .example-item {
            background-color: #36364b;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            border: 1px solid #4a4a60;
            transition: all 0.2s;
        }

        .example-item:hover {
            border-color: #6c5ce7;
            background-color: #40405a;
        }

        /* æŠ¥å‘Šå†…å®¹ */
        .report-section {
            margin-bottom: 24px;
        }

        .section-title {
            color: #6c5ce7;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .section-content {
            color: #e0e0e0;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>
                <span>ğŸ“ AIæŠ¥å‘Šå†™ä½œåŠ©æ‰‹</span>
            </h1>
            <div class="connection-area">
                <input type="text" id="threadId" class="thread-input" placeholder="å¯¹è¯ID" value="test-123">
                <button id="connectBtn" class="btn btn-primary">è¿æ¥</button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>æ–­å¼€</button>
                <span id="connectionStatus" class="status-badge status-disconnected">æœªè¿æ¥</span>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å·¦ä¾§å¯¹è¯å†å² -->
            <div class="chat-history">
                <div class="history-header">
                    ğŸ’¬ å¯¹è¯å†å²
                </div>
                <div id="messagesContainer" class="messages-container">
                    <!-- æ¬¢è¿ç•Œé¢ -->
                    <div id="welcomeScreen" class="welcome-screen">
                        <div class="welcome-title">ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIæŠ¥å‘Šå†™ä½œåŠ©æ‰‹</div>
                        <p>æˆ‘å¯ä»¥å¸®ä½ æ’°å†™å„ç§ç±»å‹çš„æŠ¥å‘Šï¼šæŠ€æœ¯æŠ¥å‘Šã€å¸‚åœºåˆ†æã€å­¦æœ¯ç»¼è¿°ç­‰</p>
                        <p>ç‚¹å‡»ä¸‹é¢çš„ç¤ºä¾‹å¼€å§‹ï¼Œæˆ–ç›´æ¥è¾“å…¥ä½ çš„éœ€æ±‚</p>
                        <div class="examples">
                            <div class="example-item" onclick="setExamplePrompt('å¸®æˆ‘å†™ä¸€ä»½å…³äºAIåŒ»ç–—çš„æŠ¥å‘Š')">ğŸ¥ AIåŒ»ç–—æŠ¥å‘Š</div>
                            <div class="example-item" onclick="setExamplePrompt('åˆ†æ2024å¹´æ–°èƒ½æºæ±½è½¦å¸‚åœºè¶‹åŠ¿')">ğŸš— æ–°èƒ½æºè½¦å¸‚åœºåˆ†æ</div>
                            <div class="example-item" onclick="setExamplePrompt('å†™ä¸€ä»½æ•°å­—åŒ–è½¬å‹çš„æŠ€æœ¯æŠ¥å‘Š')">ğŸ’» æ•°å­—åŒ–è½¬å‹æŠ¥å‘Š</div>
                            <div class="example-item" onclick="setExamplePrompt('å¸®æˆ‘è§„åˆ’ä¸€ç¯‡å…³äºé‡å­è®¡ç®—çš„ç»¼è¿°')">âš›ï¸ é‡å­è®¡ç®—ç»¼è¿°</div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒº -->
                <div class="input-area">
                    <div class="input-container">
                        <textarea id="messageInput" placeholder="è¾“å…¥ä½ çš„æŠ¥å‘Šéœ€æ±‚... (Shift + Enter æ¢è¡Œï¼ŒEnter å‘é€)"
                            rows="3"></textarea>
                        <button id="sendBtn" class="send-btn" disabled>å‘é€</button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æŠ¥å‘Šé¢„è§ˆ -->
            <div class="report-preview">
                <div class="preview-header">
                    ğŸ“„ æŠ¥å‘Šé¢„è§ˆ
                </div>
                <div id="reportContent" class="preview-content">
                    <div style="color: #666; text-align: center; margin-top: 50px;">
                        ç­‰å¾…ç”ŸæˆæŠ¥å‘Š...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentThreadId = '';
        let streamingMessageId = null;
        let streamingContent = '';
        let currentOutline = [];
        let currentPhase = 'idle'; // idle, planning, writing, reviewing

        // DOM å…ƒç´ 
        const threadIdInput = document.getElementById('threadId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const reportContent = document.getElementById('reportContent');
        const connectionStatus = document.getElementById('connectionStatus');
        const welcomeScreen = document.getElementById('welcomeScreen');

        // ç¤ºä¾‹ç‚¹å‡»
        window.setExamplePrompt = function (text) {
            messageInput.value = text;
            messageInput.focus();
        };

        // è¿æ¥
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendBtn.addEventListener('click', sendMessage);

        // Enter å‘é€
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });


        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = 'status-badge status-connected';
                connectionStatus.textContent = 'å·²è¿æ¥';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
            } else {
                connectionStatus.className = 'status-badge status-disconnected';
                connectionStatus.textContent = 'æœªè¿æ¥';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
            }
        }

        function hideWelcome() {
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
        }

        function generateRequestId() {
            return 'req_' + Math.random().toString(36).substr(2, 9);
        }


        function addUserMessage(content) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message user-message';
            wrapper.textContent = content;

            const time = document.createElement('div');
            time.className = 'message-time user-time';
            time.textContent = new Date().toLocaleTimeString();

            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.appendChild(wrapper);
            container.appendChild(time);

            messagesContainer.appendChild(container);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addAssistantMessage(content, isStreaming = false) {
            if (isStreaming && streamingMessageId) {
                // æ›´æ–°ç°æœ‰æ¶ˆæ¯
                const existingMsg = document.getElementById(streamingMessageId);
                if (existingMsg) {
                    const msgDiv = existingMsg.querySelector('.message');
                    msgDiv.innerHTML = formatContent(content);

                    // ç¡®ä¿å…‰æ ‡å­˜åœ¨
                    if (!msgDiv.querySelector('.cursor')) {
                        const cursor = document.createElement('span');
                        cursor.className = 'cursor';
                        msgDiv.appendChild(cursor);
                    }
                    return;
                }
            }

            // åˆ›å»ºæ–°æ¶ˆæ¯
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';

            if (isStreaming) {
                streamingMessageId = 'msg_' + Date.now();
                wrapper.id = streamingMessageId;
            }

            const msgDiv = document.createElement('div');
            msgDiv.className = `message assistant-message ${isStreaming ? 'streaming-message' : ''}`;
            msgDiv.innerHTML = formatContent(content);

            if (isStreaming) {
                const cursor = document.createElement('span');
                cursor.className = 'cursor';
                msgDiv.appendChild(cursor);
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString();

            wrapper.appendChild(msgDiv);
            wrapper.appendChild(time);
            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addSystemMessage(content) {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.justifyContent = 'center';

            const msgDiv = document.createElement('div');
            msgDiv.className = 'message system-message';
            msgDiv.textContent = content;

            wrapper.appendChild(msgDiv);
            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addErrorMessage(content) {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.justifyContent = 'center';

            const msgDiv = document.createElement('div');
            msgDiv.className = 'message system-message';
            msgDiv.style.backgroundColor = '#3a2a2a';
            msgDiv.style.color = '#ff6b6b';
            msgDiv.style.borderColor = '#ff6b6b';
            msgDiv.textContent = 'âŒ ' + content;

            wrapper.appendChild(msgDiv);
            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatContent(content) {
            return content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function showOutline(sections) {
            currentOutline = sections;
            currentPhase = 'reviewing';

            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';

            const card = document.createElement('div');
            card.className = 'outline-card';

            const title = document.createElement('div');
            title.className = 'outline-title';
            title.textContent = 'ğŸ“‹ ç”Ÿæˆçš„å¤§çº²';

            card.appendChild(title);

            sections.forEach((section, index) => {
                const item = document.createElement('div');
                item.className = 'outline-item';
                item.textContent = `${index + 1}. ${section.title || section}`;
                card.appendChild(item);
            });

            wrapper.appendChild(card);
            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // æ›´æ–°æŠ¥å‘Šé¢„è§ˆ
            updateReportPreview(sections);
        }

        function showConfirmation(question, options) {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'center';

            const box = document.createElement('div');
            box.className = 'confirmation-box';

            const qDiv = document.createElement('div');
            qDiv.className = 'confirmation-question';
            qDiv.textContent = question;

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'confirmation-options';

            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = `option-btn option-${getOptionClass(option)}`;
                btn.textContent = option;
                btn.onclick = () => handleOption(option);
                optionsDiv.appendChild(btn);
            });

            box.appendChild(qDiv);
            box.appendChild(optionsDiv);
            wrapper.appendChild(box);
            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getOptionClass(option) {
            switch (option) {
                case 'ç¡®è®¤': return 'confirm';
                case 'ä¿®æ”¹': return 'edit';
                case 'é‡å†™': return 'regenerate';
                default: return '';
            }
        }

        function handleOption(option) {
            if (!ws) return;

            addUserMessage(`[é€‰æ‹©] ${option}`);

            if (option === 'ç¡®è®¤') {
                currentPhase = 'writing';
                ws.send(JSON.stringify({
                    type: 'approve',
                    data: {},
                    request_id: generateRequestId()
                }));
            } else if (option === 'ä¿®æ”¹') {
                currentPhase = 'editing';
                // ç­‰å¾…ç”¨æˆ·è¾“å…¥ä¿®æ”¹æ„è§
                messageInput.placeholder = 'è¯·è¾“å…¥ä¿®æ”¹æ„è§...';
            }
        }

        function updateReportPreview(sections) {
            let html = '';
            sections.forEach((section, index) => {
                html += `
                    <div class="report-section">
                        <div class="section-title">${index + 1}. ${section.title || section}</div>
                        <div class="section-content">${section.content || 'ç­‰å¾…ç”Ÿæˆ...'}</div>
                    </div>
                `;
            });
            reportContent.innerHTML = html;
        }

        function updateSectionContent(sectionId, content) {
            // æ›´æ–°æŠ¥å‘Šé¢„è§ˆä¸­çš„æ®µè½å†…å®¹
            const sections = document.querySelectorAll('.report-section');
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µæ›´æ–°
        }

        function handleMessage(data) {
            const type = data.type;
            const eventData = data.data || {};

            console.log('æ”¶åˆ°æ¶ˆæ¯:', type, eventData);

            switch (type) {
                case 'chunk':
                    // æµå¼è¾“å‡ºå¤§çº²
                    if (eventData.section === 'outline') {
                        streamingContent += eventData.content || '';
                        addAssistantMessage(streamingContent, true);
                    }
                    break;

                case 'complete':
                    // æµå¼å®Œæˆ
                    if (eventData.sections) {
                        streamingMessageId = null;
                        streamingContent = '';
                        showOutline(eventData.sections);
                    }
                    break;

                case 'outline_complete':
                    // å¤§çº²ç”Ÿæˆå®Œæˆ
                    streamingMessageId = null;
                    streamingContent = '';
                    if (eventData.sections) {
                        showOutline(eventData.sections);
                    }
                    if (eventData.pending_question) {
                        showConfirmation(eventData.pending_question, eventData.pending_options);
                    }
                    break;

                case 'prompt':
                    // æ˜¾ç¤ºç¡®è®¤æ¡†
                    showConfirmation(eventData.question, eventData.options);
                    break;

                case 'section_ready':
                    // æ®µè½å°±ç»ª
                    addAssistantMessage(`ğŸ“ **${eventData.title}**\n\n${eventData.content}`);
                    updateSectionContent(eventData.section_id, eventData.content);
                    showConfirmation(eventData.question, eventData.options);
                    break;

                case 'section_updated':
                    // æ®µè½æ›´æ–°
                    updateSectionContent(eventData.section_id, eventData.content);
                    addAssistantMessage(`âœï¸ æ®µè½å·²æ›´æ–° (v${eventData.version})`);
                    break;

                case 'report_completed':
                    // æŠ¥å‘Šå®Œæˆ
                    addSystemMessage('ğŸ‰ æŠ¥å‘Šå·²å…¨éƒ¨å®Œæˆï¼');
                    currentPhase = 'completed';
                    break;

                case 'sync':
                    if (eventData.type === 'history' && eventData.messages) {
                        // æ˜¾ç¤ºå†å²æ¶ˆæ¯
                        hideWelcome();
                        eventData.messages.forEach(msg => {
                            if (msg.role === 'user') {
                                addUserMessage(msg.content);
                            } else if (msg.role === 'assistant') {
                                addAssistantMessage(msg.content);
                            }
                        });
                    } else if (eventData.type === 'state' && eventData.sections) {
                        showOutline(eventData.sections);
                        if (eventData.pending_question) {
                            showConfirmation(eventData.pending_question, eventData.pending_options);
                        }
                    }
                    break;

                case 'error':
                    addErrorMessage(`${eventData.code}: ${eventData.message}`);
                    break;
            }
        }



        function connect() {
            const threadId = threadIdInput.value.trim();
            if (!threadId) return;

            currentThreadId = threadId;
            const wsUrl = `ws://${window.location.host}/ws/${threadId}`;

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    updateConnectionStatus(true);
                    hideWelcome();
                    addSystemMessage('âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    addSystemMessage('ğŸ’¡ è¯·è¾“å…¥ä½ çš„æŠ¥å‘Šéœ€æ±‚ï¼Œä¾‹å¦‚ï¼š"å¸®æˆ‘å†™ä¸€ä»½å…³äºAIåŒ»ç–—çš„æŠ¥å‘Š"');

                    // ä¸è‡ªåŠ¨å‘é€ startï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                };

                ws.onclose = () => {
                    updateConnectionStatus(false);
                    addSystemMessage('ğŸ”Œ è¿æ¥å·²æ–­å¼€');
                };

                ws.onerror = () => {
                    addErrorMessage('è¿æ¥é”™è¯¯');
                };

            } catch (e) {
                addErrorMessage('è¿æ¥å¤±è´¥: ' + e.message);
            }
        }

        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥');
                return;
            }

            const content = messageInput.value.trim();
            if (!content) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(content);

            // åˆ¤æ–­æ˜¯ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯è¿˜æ˜¯åç»­å¯¹è¯
            const hasHistory = document.querySelectorAll('.user-message').length > 1; // æ’é™¤åˆšå‘çš„è¿™æ¡

            if (!hasHistory) {
                // ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼Œç”¨ start äº‹ä»¶
                ws.send(JSON.stringify({
                    type: 'start',
                    data: {
                        title: content.substring(0, 30) + '...',  // ç”¨æ¶ˆæ¯å†…å®¹ä½œä¸ºæ ‡é¢˜
                        context: {}
                    },
                    request_id: generateRequestId()
                }));
            } else {
                // åç»­æ¶ˆæ¯ç”¨ message äº‹ä»¶
                ws.send(JSON.stringify({
                    type: 'message',
                    data: { content: content },
                    request_id: generateRequestId()
                }));
            }

            messageInput.value = '';
        }
    </script>
</body>

</html>